import{map}from"../operators/map";import{Observable}from"../Observable";import{AjaxResponse}from"./AjaxResponse";import{AjaxTimeoutError,AjaxError}from"./errors";function ajaxGet(e,r){return ajax({method:"GET",url:e,headers:r})}function ajaxPost(e,r,t){return ajax({method:"POST",url:e,body:r,headers:t})}function ajaxDelete(e,r){return ajax({method:"DELETE",url:e,headers:r})}function ajaxPut(e,r,t){return ajax({method:"PUT",url:e,body:r,headers:t})}function ajaxPatch(e,r,t){return ajax({method:"PATCH",url:e,body:r,headers:t})}let mapResponse=map(e=>e.response);function ajaxGetJSON(e,r){return mapResponse(ajax({method:"GET",url:e,headers:r}))}let ajax=(()=>{var e=e=>fromAjax("string"==typeof e?{url:e}:e);return e.get=ajaxGet,e.post=ajaxPost,e.delete=ajaxDelete,e.put=ajaxPut,e.patch=ajaxPatch,e.getJSON=ajaxGetJSON,e})(),UPLOAD="upload",DOWNLOAD="download",LOADSTART="loadstart",PROGRESS="progress",LOAD="load";function fromAjax(m){return new Observable(i=>{var e=Object.assign({async:!0,crossDomain:!1,withCredentials:!1,method:"GET",timeout:0,responseType:"json"},m),{queryParams:r,body:t,headers:a}=e;let n=e.url;if(!n)throw new TypeError("url is required");if(r){let t;if(n.includes("?")){var s=n.split("?");if(2<s.length)throw new TypeError("invalid url");t=new URLSearchParams(s[1]),new URLSearchParams(r).forEach((e,r)=>t.set(r,e)),n=s[0]+"?"+t}else t=new URLSearchParams(r),n=n+"?"+t}var o={};if(a)for(var u in a)a.hasOwnProperty(u)&&(o[u.toLowerCase()]=a[u]);var s=e.crossDomain,{withCredentials:r,xsrfCookieName:l,xsrfHeaderName:d}=(s||"x-requested-with"in o||(o["x-requested-with"]="XMLHttpRequest"),e),r=((r||!s)&&l&&d&&(l=null!=(s=null==(r=null==document?void 0:document.cookie.match(new RegExp(`(^|;\\s*)(${l})=([^;]*)`)))?void 0:r.pop())?s:"")&&(o[d]=l),extractContentTypeAndMaybeSerializeBody(t,o));let c=Object.assign(Object.assign({},e),{url:n,headers:o,body:r}),f;f=m.createXHR?m.createXHR():new XMLHttpRequest;{let{progressSubscriber:a,includeDownloadProgress:e=!1,includeUploadProgress:r=!1}=m;s=(e,t)=>{f.addEventListener(e,()=>{var e,r=t();null!=(e=null==a?void 0:a.error)&&e.call(a,r),i.error(r)})};s("timeout",()=>new AjaxTimeoutError(f,c)),s("abort",()=>new AjaxError("aborted",f,c));let n=(e,r)=>new AjaxResponse(r,f,c,e+"_"+r.type),t=(e,r,t)=>{e.addEventListener(r,e=>{i.next(n(t,e))})},o=(r&&[LOADSTART,PROGRESS,LOAD].forEach(e=>t(f.upload,e,UPLOAD)),a&&[LOADSTART,PROGRESS].forEach(e=>f.upload.addEventListener(e,e=>{var r;return null==(r=null==a?void 0:a.next)?void 0:r.call(a,e)})),e&&[LOADSTART,PROGRESS].forEach(e=>t(f,e,DOWNLOAD)),e=>{i.error(new AjaxError("ajax error"+(e?" "+e:""),f,c))});f.addEventListener("error",e=>{var r;null!=(r=null==a?void 0:a.error)&&r.call(a,e),o()}),f.addEventListener(LOAD,r=>{var t,e=f.status;if(e<400){null!=(t=null==a?void 0:a.complete)&&t.call(a);let e;try{e=n(DOWNLOAD,r)}catch(e){return void i.error(e)}i.next(e),i.complete()}else null!=(t=null==a?void 0:a.error)&&t.call(a,r),o(e)})}var p,{user:d,method:l,async:t}=c;for(p in d?f.open(l,n,t,d,c.password):f.open(l,n,t),t&&(f.timeout=c.timeout,f.responseType=c.responseType),"withCredentials"in f&&(f.withCredentials=c.withCredentials),o)o.hasOwnProperty(p)&&f.setRequestHeader(p,o[p]);return r?f.send(r):f.send(),()=>{f&&4!==f.readyState&&f.abort()}})}function extractContentTypeAndMaybeSerializeBody(e,r){if(!e||"string"==typeof e||isFormData(e)||isURLSearchParams(e)||isArrayBuffer(e)||isFile(e)||isBlob(e)||isReadableStream(e))return e;if(isArrayBufferView(e))return e.buffer;if("object"==typeof e)return r["content-type"]=null!=(r=r["content-type"])?r:"application/json;charset=utf-8",JSON.stringify(e);throw new TypeError("Unknown body type")}let _toString=Object.prototype.toString;function toStringCheck(e,r){return _toString.call(e)===`[object ${r}]`}function isArrayBuffer(e){return toStringCheck(e,"ArrayBuffer")}function isFile(e){return toStringCheck(e,"File")}function isBlob(e){return toStringCheck(e,"Blob")}function isArrayBufferView(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)}function isFormData(e){return"undefined"!=typeof FormData&&e instanceof FormData}function isURLSearchParams(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams}function isReadableStream(e){return"undefined"!=typeof ReadableStream&&e instanceof ReadableStream}export{ajax,fromAjax};