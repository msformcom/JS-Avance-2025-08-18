import{isFunction}from"./util/isFunction";import{UnsubscriptionError}from"./util/UnsubscriptionError";import{arrRemove}from"./util/arrRemove";class Subscription{constructor(i){this.initialTeardown=i,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let r;if(!this.closed){this.closed=!0;var i=this._parentage;if(i)if(this._parentage=null,Array.isArray(i))for(var s of i)s.remove(this);else i.remove(this);i=this.initialTeardown;if(isFunction(i))try{i()}catch(i){r=i instanceof UnsubscriptionError?i.errors:[i]}i=this._finalizers;if(i){this._finalizers=null;for(var n of i)try{execFinalizer(n)}catch(i){r=null!=r?r:[],i instanceof UnsubscriptionError?r=[...r,...i.errors]:r.push(i)}}if(r)throw new UnsubscriptionError(r)}}add(i){var r;if(i&&i!==this)if(this.closed)execFinalizer(i);else{if(i instanceof Subscription){if(i.closed||i._hasParent(this))return;i._addParent(this)}(this._finalizers=null!=(r=this._finalizers)?r:[]).push(i)}}_hasParent(i){var r=this._parentage;return r===i||Array.isArray(r)&&r.includes(i)}_addParent(i){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(i),r):r?[r,i]:i}_removeParent(i){var r=this._parentage;r===i?this._parentage=null:Array.isArray(r)&&arrRemove(r,i)}remove(i){var r=this._finalizers;r&&arrRemove(r,i),i instanceof Subscription&&i._removeParent(this)}}Subscription.EMPTY=(()=>{var i=new Subscription;return i.closed=!0,i})();let EMPTY_SUBSCRIPTION=Subscription.EMPTY;function isSubscription(i){return i instanceof Subscription||i&&"closed"in i&&isFunction(i.remove)&&isFunction(i.add)&&isFunction(i.unsubscribe)}function execFinalizer(i){isFunction(i)?i():i.unsubscribe()}export{Subscription,EMPTY_SUBSCRIPTION,isSubscription};