import{__extends,__read,__spreadArray,__values}from"tslib";import{Observable}from"../Observable";import{ColdObservable}from"./ColdObservable";import{HotObservable}from"./HotObservable";import{SubscriptionLog}from"./SubscriptionLog";import{VirtualTimeScheduler,VirtualAction}from"../scheduler/VirtualTimeScheduler";import{COMPLETE_NOTIFICATION,errorNotification,nextNotification}from"../NotificationFactories";import{dateTimestampProvider}from"../scheduler/dateTimestampProvider";import{performanceTimestampProvider}from"../scheduler/performanceTimestampProvider";import{animationFrameProvider}from"../scheduler/animationFrameProvider";import{immediateProvider}from"../scheduler/immediateProvider";import{intervalProvider}from"../scheduler/intervalProvider";import{timeoutProvider}from"../scheduler/timeoutProvider";var defaultMaxFrame=750,TestScheduler=(t=>{function c(e){var r=t.call(this,VirtualAction,defaultMaxFrame)||this;return r.assertDeepEqual=e,r.hotObservables=[],r.coldObservables=[],r.flushTests=[],r.runMode=!1,r}return __extends(c,t),c.prototype.createTime=function(e){e=(this.runMode?e.trim():e).indexOf("|");if(-1===e)throw new Error('marble diagram for time should have a completion marker "|"');return e*c.frameTimeFactor},c.prototype.createColdObservable=function(e,r,t){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');e=c.parseMarbles(e,r,t,void 0,this.runMode),r=new ColdObservable(e,this);return this.coldObservables.push(r),r},c.prototype.createHotObservable=function(e,r,t){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');e=c.parseMarbles(e,r,t,void 0,this.runMode),r=new HotObservable(e,this);return this.hotObservables.push(r),r},c.prototype.materializeInnerObservable=function(e,r){var t=this,i=[];return e.subscribe({next:function(e){i.push({frame:t.frame-r,notification:nextNotification(e)})},error:function(e){i.push({frame:t.frame-r,notification:errorNotification(e)})},complete:function(){i.push({frame:t.frame-r,notification:COMPLETE_NOTIFICATION})}}),i},c.prototype.expectObservable=function(e,r){var t,i=this,a=[],o={actual:a,ready:!1},r=c.parseMarblesAsSubscriptions(r=void 0===r?null:r,this.runMode),n=r.subscribedFrame===1/0?0:r.subscribedFrame,r=r.unsubscribedFrame,s=(this.schedule(function(){t=e.subscribe({next:function(e){e=e instanceof Observable?i.materializeInnerObservable(e,i.frame):e;a.push({frame:i.frame,notification:nextNotification(e)})},error:function(e){a.push({frame:i.frame,notification:errorNotification(e)})},complete:function(){a.push({frame:i.frame,notification:COMPLETE_NOTIFICATION})}})},n),r!==1/0&&this.schedule(function(){return t.unsubscribe()},r),this.flushTests.push(o),this.runMode);return{toBe:function(e,r,t){o.ready=!0,o.expected=c.parseMarbles(e,r,t,!0,s)},toEqual:function(e){o.ready=!0,o.expected=[],i.schedule(function(){t=e.subscribe({next:function(e){e=e instanceof Observable?i.materializeInnerObservable(e,i.frame):e;o.expected.push({frame:i.frame,notification:nextNotification(e)})},error:function(e){o.expected.push({frame:i.frame,notification:errorNotification(e)})},complete:function(){o.expected.push({frame:i.frame,notification:COMPLETE_NOTIFICATION})}})},n)}}},c.prototype.expectSubscriptions=function(e){var r={actual:e,ready:!1},t=(this.flushTests.push(r),this.runMode);return{toBe:function(e){e="string"==typeof e?[e]:e;r.ready=!0,r.expected=e.map(function(e){return c.parseMarblesAsSubscriptions(e,t)}).filter(function(e){return e.subscribedFrame!==1/0})}}},c.prototype.flush=function(){for(var r=this,e=this.hotObservables;0<e.length;)e.shift().setup();t.prototype.flush.call(this),this.flushTests=this.flushTests.filter(function(e){return!e.ready||(r.assertDeepEqual(e.actual,e.expected),!1)})},c.parseMarblesAsSubscriptions=function(e,s){var c=this;if(void 0===s&&(s=!1),"string"!=typeof e)return new SubscriptionLog(1/0);for(var u,l=__spreadArray([],__read(e)),r=l.length,d=-1,m=1/0,f=1/0,h=0,t=function(e){function r(e){t+=e*c.frameTimeFactor}var t=h,i=l[e];switch(i){case" ":s||r(1);break;case"-":r(1);break;case"(":d=h,r(1);break;case")":d=-1,r(1);break;case"^":if(m!==1/0)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");m=-1<d?d:h,r(1);break;case"!":if(f!==1/0)throw new Error("found a second unsubscription point '!' in a subscription marble diagram. There can only be one.");f=-1<d?d:h;break;default:if(s&&i.match(/^[0-9]$/)&&(0===e||" "===l[e-1])){var a=l.slice(e).join("").match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(a){e+=a[0].length-1;var o=parseFloat(a[1]),n=void 0;switch(a[2]){case"ms":n=o;break;case"s":n=1e3*o;break;case"m":n=1e3*o*60}r(n/b.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+i+"'.")}h=t,u=e},b=this,i=0;i<r;i++)t(i),i=u;return f<0?new SubscriptionLog(m):new SubscriptionLog(m,f)},c.parseMarbles=function(e,r,c,t,u){var l=this;if(void 0===t&&(t=!1),void 0===u&&(u=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var d,m=__spreadArray([],__read(e)),i=m.length,f=[],e=(u?e.replace(/^[ ]+/,""):e).indexOf("^"),h=-1===e?0:e*-this.frameTimeFactor,b="object"!=typeof r?function(e){return e}:function(e){return t&&r[e]instanceof ColdObservable?r[e].messages:r[e]},p=-1,a=function(e){function r(e){t+=e*l.frameTimeFactor}var t=h,i=void 0,a=m[e];switch(a){case" ":u||r(1);break;case"-":r(1);break;case"(":p=h,r(1);break;case")":p=-1,r(1);break;case"|":i=COMPLETE_NOTIFICATION,r(1);break;case"^":r(1);break;case"#":i=errorNotification(c||"error"),r(1);break;default:if(u&&a.match(/^[0-9]$/)&&(0===e||" "===m[e-1])){var o=m.slice(e).join("").match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(o){e+=o[0].length-1;var n=parseFloat(o[1]),s=void 0;switch(o[2]){case"ms":s=n;break;case"s":s=1e3*n;break;case"m":s=1e3*n*60}r(s/v.frameTimeFactor);break}}i=nextNotification(b(a)),r(1)}i&&f.push({frame:-1<p?p:h,notification:i}),h=t,d=e},v=this,o=0;o<i;o++)a(o),o=d;return f},c.prototype.createAnimator=function(){var t,n,s=this;if(this.runMode)return t=0,{animate:function(e){var r,t;if(n)throw new Error("animate() must not be called more than once within run()");if(/[|#]/.test(e))throw new Error("animate() must not complete or error");n=new Map;e=c.parseMarbles(e,void 0,void 0,void 0,!0);try{for(var i=__values(e),a=i.next();!a.done;a=i.next()){var o=a.value;s.schedule(function(){var r,e,t=s.now(),i=Array.from(n.values());n.clear();try{r=void 0;for(var a=__values(i),o=a.next();!o.done;o=a.next())(0,o.value)(t)}catch(e){r={error:e}}finally{try{o&&!o.done&&(e=a.return)&&e.call(a)}finally{if(r)throw r.error}}},o.frame)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(t=i.return)&&t.call(i)}finally{if(r)throw r.error}}},delegate:{requestAnimationFrame:function(e){var r;if(n)return r=++t,n.set(r,e),r;throw new Error("animate() was not called within run()")},cancelAnimationFrame:function(e){if(!n)throw new Error("animate() was not called within run()");n.delete(e)}}};throw new Error("animate() must only be used in run mode")},c.prototype.createDelegates=function(){var n=this,i=0,s=new Map,c=function(){var r=n.now(),e=Array.from(s.values()).filter(function(e){return e.due<=r}),t=e.filter(function(e){return"immediate"===e.type});if(0<t.length)a=(t=t[0]).handle,o=t.handler,s.delete(a);else{var t;if(0<(t=e.filter(function(e){return"interval"===e.type})).length)i=(t=t[0]).duration,o=t.handler,t.due=r+i,t.subscription=n.schedule(c,i);else{var i,a,o,t=e.filter(function(e){return"timeout"===e.type});if(!(0<t.length))throw new Error("Expected a due immediate or interval");a=(i=t[0]).handle,o=i.handler,s.delete(a)}}o()};return{immediate:{setImmediate:function(e){var r=++i;return s.set(r,{due:n.now(),duration:0,handle:r,handler:e,subscription:n.schedule(c,0),type:"immediate"}),r},clearImmediate:function(e){var r=s.get(e);r&&(r.subscription.unsubscribe(),s.delete(e))}},interval:{setInterval:function(e,r){void 0===r&&(r=0);var t=++i;return s.set(t,{due:n.now()+r,duration:r,handle:t,handler:e,subscription:n.schedule(c,r),type:"interval"}),t},clearInterval:function(e){var r=s.get(e);r&&(r.subscription.unsubscribe(),s.delete(e))}},timeout:{setTimeout:function(e,r){void 0===r&&(r=0);var t=++i;return s.set(t,{due:n.now()+r,duration:r,handle:t,handler:e,subscription:n.schedule(c,r),type:"timeout"}),t},clearTimeout:function(e){var r=s.get(e);r&&(r.subscription.unsubscribe(),s.delete(e))}}}},c.prototype.run=function(e){var r=c.frameTimeFactor,t=this.maxFrames,i=(c.frameTimeFactor=1,this.maxFrames=1/0,this.runMode=!0,this.createAnimator()),a=this.createDelegates(),a=(animationFrameProvider.delegate=i.delegate,dateTimestampProvider.delegate=this,immediateProvider.delegate=a.immediate,intervalProvider.delegate=a.interval,timeoutProvider.delegate=a.timeout,{cold:(performanceTimestampProvider.delegate=this).createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),time:this.createTime.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this),animate:i.animate});try{var o=e(a);return this.flush(),o}finally{c.frameTimeFactor=r,this.maxFrames=t,this.runMode=!1,animationFrameProvider.delegate=void 0,dateTimestampProvider.delegate=void 0,immediateProvider.delegate=void 0,intervalProvider.delegate=void 0,timeoutProvider.delegate=void 0,performanceTimestampProvider.delegate=void 0}},c.frameTimeFactor=10,c})(VirtualTimeScheduler);export{TestScheduler};