import{__assign}from"tslib";import{map}from"../operators/map";import{Observable}from"../Observable";import{AjaxResponse}from"./AjaxResponse";import{AjaxTimeoutError,AjaxError}from"./errors";function ajaxGet(e,r){return ajax({method:"GET",url:e,headers:r})}function ajaxPost(e,r,t){return ajax({method:"POST",url:e,body:r,headers:t})}function ajaxDelete(e,r){return ajax({method:"DELETE",url:e,headers:r})}function ajaxPut(e,r,t){return ajax({method:"PUT",url:e,body:r,headers:t})}function ajaxPatch(e,r,t){return ajax({method:"PATCH",url:e,body:r,headers:t})}var mapResponse=map(function(e){return e.response});function ajaxGetJSON(e,r){return mapResponse(ajax({method:"GET",url:e,headers:r}))}var ajax=(()=>{function e(e){return fromAjax("string"==typeof e?{url:e}:e)}return e.get=ajaxGet,e.post=ajaxPost,e.delete=ajaxDelete,e.put=ajaxPut,e.patch=ajaxPatch,e.getJSON=ajaxGetJSON,e})(),UPLOAD="upload",DOWNLOAD="download",LOADSTART="loadstart",PROGRESS="progress",LOAD="load";function fromAjax(S){return new Observable(function(n){var t,e=__assign({async:!0,crossDomain:!1,withCredentials:!1,method:"GET",timeout:0,responseType:"json"},S),r=e.queryParams,a=e.body,o=e.headers,i=e.url;if(!i)throw new TypeError("url is required");if(r)if(i.includes("?")){var u=i.split("?");if(2<u.length)throw new TypeError("invalid url");t=new URLSearchParams(u[1]),new URLSearchParams(r).forEach(function(e,r){return t.set(r,e)}),i=u[0]+"?"+t}else i=i+"?"+(t=new URLSearchParams(r));var s={};if(o)for(var l in o)o.hasOwnProperty(l)&&(s[l.toLowerCase()]=o[l]);var u=e.crossDomain;u||"x-requested-with"in s||(s["x-requested-with"]="XMLHttpRequest");function f(e,t){h.addEventListener(e,function(){var e,r=t();null!=(e=null==y?void 0:y.error)&&e.call(y,r),n.error(r)})}function d(e,r,t){e.addEventListener(r,function(e){n.next(x(t,e))})}function c(e){n.error(new AjaxError("ajax error"+(e?" "+e:""),h,m))}var r=e.xsrfCookieName,p=e.xsrfHeaderName,r=((e.withCredentials||!u)&&r&&p&&(u=null!=(r=null==(u=null==document?void 0:document.cookie.match(new RegExp("(^|;\\s*)("+r+")=([^;]*)")))?void 0:u.pop())?r:"")&&(s[p]=u),extractContentTypeAndMaybeSerializeBody(a,s)),m=__assign(__assign({},e),{url:i,headers:s,body:r}),h=S.createXHR?S.createXHR():new XMLHttpRequest,y=S.progressSubscriber,p=S.includeDownloadProgress,u=void 0!==p&&p,a=S.includeUploadProgress,e=void 0!==a&&a,x=(f("timeout",function(){return new AjaxTimeoutError(h,m)}),f("abort",function(){return new AjaxError("aborted",h,m)}),function(e,r){return new AjaxResponse(r,h,m,e+"_"+r.type)}),p=(e&&[LOADSTART,PROGRESS,LOAD].forEach(function(e){return d(h.upload,e,UPLOAD)}),y&&[LOADSTART,PROGRESS].forEach(function(e){return h.upload.addEventListener(e,function(e){var r;return null==(r=null==y?void 0:y.next)?void 0:r.call(y,e)})}),u&&[LOADSTART,PROGRESS].forEach(function(e){return d(h,e,DOWNLOAD)}),h.addEventListener("error",function(e){var r;null!=(r=null==y?void 0:y.error)&&r.call(y,e),c()}),h.addEventListener(LOAD,function(e){var r=h.status;if(r<400){null!=(t=null==y?void 0:y.complete)&&t.call(y);var t=void 0;try{t=x(DOWNLOAD,e)}catch(e){return void n.error(e)}n.next(t),n.complete()}else null!=(t=null==y?void 0:y.error)&&t.call(y,e),c(r)}),m.user),a=m.method,e=m.async;for(l in p?h.open(a,i,e,p,m.password):h.open(a,i,e),e&&(h.timeout=m.timeout,h.responseType=m.responseType),"withCredentials"in h&&(h.withCredentials=m.withCredentials),s)s.hasOwnProperty(l)&&h.setRequestHeader(l,s[l]);return r?h.send(r):h.send(),function(){h&&4!==h.readyState&&h.abort()}})}function extractContentTypeAndMaybeSerializeBody(e,r){if(!e||"string"==typeof e||isFormData(e)||isURLSearchParams(e)||isArrayBuffer(e)||isFile(e)||isBlob(e)||isReadableStream(e))return e;if(isArrayBufferView(e))return e.buffer;if("object"==typeof e)return r["content-type"]=null!=(r=r["content-type"])?r:"application/json;charset=utf-8",JSON.stringify(e);throw new TypeError("Unknown body type")}var _toString=Object.prototype.toString;function toStringCheck(e,r){return _toString.call(e)==="[object "+r+"]"}function isArrayBuffer(e){return toStringCheck(e,"ArrayBuffer")}function isFile(e){return toStringCheck(e,"File")}function isBlob(e){return toStringCheck(e,"Blob")}function isArrayBufferView(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)}function isFormData(e){return"undefined"!=typeof FormData&&e instanceof FormData}function isURLSearchParams(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams}function isReadableStream(e){return"undefined"!=typeof ReadableStream&&e instanceof ReadableStream}export{ajax,fromAjax};