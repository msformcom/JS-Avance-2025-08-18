import{__assign,__extends}from"tslib";import{Subject,AnonymousSubject}from"../../Subject";import{Subscriber}from"../../Subscriber";import{Observable}from"../../Observable";import{Subscription}from"../../Subscription";import{ReplaySubject}from"../../ReplaySubject";var DEFAULT_WEBSOCKET_CONFIG={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",WebSocketSubject=(c=>{function r(e,t){var r=c.call(this)||this;if(r._socket=null,e instanceof Observable)r.destination=t,r.source=e;else{var o=r._config=__assign({},DEFAULT_WEBSOCKET_CONFIG);if(r._output=new Subject,"string"==typeof e)o.url=e;else for(var n in e)e.hasOwnProperty(n)&&(o[n]=e[n]);if(!o.WebSocketCtor&&WebSocket)o.WebSocketCtor=WebSocket;else if(!o.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new ReplaySubject}return r}return __extends(r,c),r.prototype.lift=function(e){var t=new r(this._config,this.destination);return t.operator=e,t.source=this,t},r.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new ReplaySubject),this._output=new Subject},r.prototype.multiplex=function(r,o,n){var c=this;return new Observable(function(t){try{c.next(r())}catch(e){t.error(e)}var e=c.subscribe({next:function(e){try{n(e)&&t.next(e)}catch(e){t.error(e)}},error:function(e){return t.error(e)},complete:function(){return t.complete()}});return function(){try{c.next(o())}catch(e){t.error(e)}e.unsubscribe()}})},r.prototype._connectSocket=function(){var r=this,e=this._config,t=e.WebSocketCtor,o=e.protocol,n=e.url,e=e.binaryType,c=this._output,i=null;try{i=o?new t(n,o):new t(n),this._socket=i,e&&(this._socket.binaryType=e)}catch(e){return void c.error(e)}var s=new Subscription(function(){r._socket=null,i&&1===i.readyState&&i.close()});i.onopen=function(e){var t;r._socket?((t=r._config.openObserver)&&t.next(e),t=r.destination,r.destination=Subscriber.create(function(e){if(1===i.readyState)try{var t=r._config.serializer;i.send(t(e))}catch(e){r.destination.error(e)}},function(e){var t=r._config.closingObserver;t&&t.next(void 0),e&&e.code?i.close(e.code,e.reason):c.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT)),r._resetState()},function(){var e=r._config.closingObserver;e&&e.next(void 0),i.close(),r._resetState()}),t&&t instanceof ReplaySubject&&s.add(t.subscribe(r.destination))):(i.close(),r._resetState())},i.onerror=function(e){r._resetState(),c.error(e)},i.onclose=function(e){i===r._socket&&r._resetState();var t=r._config.closeObserver;t&&t.next(e),e.wasClean?c.complete():c.error(e)},i.onmessage=function(e){try{var t=r._config.deserializer;c.next(t(e))}catch(e){c.error(e)}}},r.prototype._subscribe=function(e){var t=this,r=this.source;return r?r.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(function(){var e=t._socket;0===t._output.observers.length&&(!e||1!==e.readyState&&0!==e.readyState||e.close(),t._resetState())}),e)},r.prototype.unsubscribe=function(){var e=this._socket;!e||1!==e.readyState&&0!==e.readyState||e.close(),this._resetState(),c.prototype.unsubscribe.call(this)},r})(AnonymousSubject);export{WebSocketSubject};