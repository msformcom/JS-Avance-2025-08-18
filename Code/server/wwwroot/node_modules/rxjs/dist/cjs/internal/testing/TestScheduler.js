var __extends=this&&this.__extends||(()=>{var i=function(e,r){return(i=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,r){e.__proto__=r}:function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}))(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=e}i(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}})(),__read=this&&this.__read||function(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var i,a,o=t.call(e),n=[];try{for(;(void 0===r||0<r--)&&!(i=o.next()).done;)n.push(i.value)}catch(e){a={error:e}}finally{try{i&&!i.done&&(t=o.return)&&t.call(o)}finally{if(a)throw a.error}}return n},__spreadArray=this&&this.__spreadArray||function(e,r){for(var t=0,i=r.length,a=e.length;t<i;t++,a++)e[a]=r[t];return e},__values=this&&this.__values||function(e){var r="function"==typeof Symbol&&Symbol.iterator,t=r&&e[r],i=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&i>=e.length?void 0:e)&&e[i++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")},Observable_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.TestScheduler=void 0,require("../Observable")),ColdObservable_1=require("./ColdObservable"),HotObservable_1=require("./HotObservable"),SubscriptionLog_1=require("./SubscriptionLog"),VirtualTimeScheduler_1=require("../scheduler/VirtualTimeScheduler"),NotificationFactories_1=require("../NotificationFactories"),dateTimestampProvider_1=require("../scheduler/dateTimestampProvider"),performanceTimestampProvider_1=require("../scheduler/performanceTimestampProvider"),animationFrameProvider_1=require("../scheduler/animationFrameProvider"),immediateProvider_1=require("../scheduler/immediateProvider"),intervalProvider_1=require("../scheduler/intervalProvider"),timeoutProvider_1=require("../scheduler/timeoutProvider"),defaultMaxFrame=750,TestScheduler=(t=>{function c(e){var r=t.call(this,VirtualTimeScheduler_1.VirtualAction,defaultMaxFrame)||this;return r.assertDeepEqual=e,r.hotObservables=[],r.coldObservables=[],r.flushTests=[],r.runMode=!1,r}return __extends(c,t),c.prototype.createTime=function(e){e=(this.runMode?e.trim():e).indexOf("|");if(-1===e)throw new Error('marble diagram for time should have a completion marker "|"');return e*c.frameTimeFactor},c.prototype.createColdObservable=function(e,r,t){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');e=c.parseMarbles(e,r,t,void 0,this.runMode),r=new ColdObservable_1.ColdObservable(e,this);return this.coldObservables.push(r),r},c.prototype.createHotObservable=function(e,r,t){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');e=c.parseMarbles(e,r,t,void 0,this.runMode),r=new HotObservable_1.HotObservable(e,this);return this.hotObservables.push(r),r},c.prototype.materializeInnerObservable=function(e,r){var t=this,i=[];return e.subscribe({next:function(e){i.push({frame:t.frame-r,notification:NotificationFactories_1.nextNotification(e)})},error:function(e){i.push({frame:t.frame-r,notification:NotificationFactories_1.errorNotification(e)})},complete:function(){i.push({frame:t.frame-r,notification:NotificationFactories_1.COMPLETE_NOTIFICATION})}}),i},c.prototype.expectObservable=function(e,r){var t,i=this,a=[],o={actual:a,ready:!1},r=c.parseMarblesAsSubscriptions(r=void 0===r?null:r,this.runMode),n=r.subscribedFrame===1/0?0:r.subscribedFrame,r=r.unsubscribedFrame,s=(this.schedule(function(){t=e.subscribe({next:function(e){e=e instanceof Observable_1.Observable?i.materializeInnerObservable(e,i.frame):e;a.push({frame:i.frame,notification:NotificationFactories_1.nextNotification(e)})},error:function(e){a.push({frame:i.frame,notification:NotificationFactories_1.errorNotification(e)})},complete:function(){a.push({frame:i.frame,notification:NotificationFactories_1.COMPLETE_NOTIFICATION})}})},n),r!==1/0&&this.schedule(function(){return t.unsubscribe()},r),this.flushTests.push(o),this.runMode);return{toBe:function(e,r,t){o.ready=!0,o.expected=c.parseMarbles(e,r,t,!0,s)},toEqual:function(e){o.ready=!0,o.expected=[],i.schedule(function(){t=e.subscribe({next:function(e){e=e instanceof Observable_1.Observable?i.materializeInnerObservable(e,i.frame):e;o.expected.push({frame:i.frame,notification:NotificationFactories_1.nextNotification(e)})},error:function(e){o.expected.push({frame:i.frame,notification:NotificationFactories_1.errorNotification(e)})},complete:function(){o.expected.push({frame:i.frame,notification:NotificationFactories_1.COMPLETE_NOTIFICATION})}})},n)}}},c.prototype.expectSubscriptions=function(e){var r={actual:e,ready:!1},t=(this.flushTests.push(r),this.runMode);return{toBe:function(e){e="string"==typeof e?[e]:e;r.ready=!0,r.expected=e.map(function(e){return c.parseMarblesAsSubscriptions(e,t)}).filter(function(e){return e.subscribedFrame!==1/0})}}},c.prototype.flush=function(){for(var r=this,e=this.hotObservables;0<e.length;)e.shift().setup();t.prototype.flush.call(this),this.flushTests=this.flushTests.filter(function(e){return!e.ready||(r.assertDeepEqual(e.actual,e.expected),!1)})},c.parseMarblesAsSubscriptions=function(e,s){var c=this;if(void 0===s&&(s=!1),"string"!=typeof e)return new SubscriptionLog_1.SubscriptionLog(1/0);for(var u,l=__spreadArray([],__read(e)),r=l.length,d=-1,f=1/0,m=1/0,h=0,t=function(e){function r(e){t+=e*c.frameTimeFactor}var t=h,i=l[e];switch(i){case" ":s||r(1);break;case"-":r(1);break;case"(":d=h,r(1);break;case")":d=-1,r(1);break;case"^":if(f!==1/0)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");f=-1<d?d:h,r(1);break;case"!":if(m!==1/0)throw new Error("found a second unsubscription point '!' in a subscription marble diagram. There can only be one.");m=-1<d?d:h;break;default:if(s&&i.match(/^[0-9]$/)&&(0===e||" "===l[e-1])){var a=l.slice(e).join("").match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(a){e+=a[0].length-1;var o=parseFloat(a[1]),n=void 0;switch(a[2]){case"ms":n=o;break;case"s":n=1e3*o;break;case"m":n=1e3*o*60}r(n/b.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+i+"'.")}h=t,u=e},b=this,i=0;i<r;i++)t(i),i=u;return m<0?new SubscriptionLog_1.SubscriptionLog(f):new SubscriptionLog_1.SubscriptionLog(f,m)},c.parseMarbles=function(e,r,c,t,u){var l=this;if(void 0===t&&(t=!1),void 0===u&&(u=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var d,f=__spreadArray([],__read(e)),i=f.length,m=[],e=(u?e.replace(/^[ ]+/,""):e).indexOf("^"),h=-1===e?0:e*-this.frameTimeFactor,b="object"!=typeof r?function(e){return e}:function(e){return t&&r[e]instanceof ColdObservable_1.ColdObservable?r[e].messages:r[e]},v=-1,a=function(e){function r(e){t+=e*l.frameTimeFactor}var t=h,i=void 0,a=f[e];switch(a){case" ":u||r(1);break;case"-":r(1);break;case"(":v=h,r(1);break;case")":v=-1,r(1);break;case"|":i=NotificationFactories_1.COMPLETE_NOTIFICATION,r(1);break;case"^":r(1);break;case"#":i=NotificationFactories_1.errorNotification(c||"error"),r(1);break;default:if(u&&a.match(/^[0-9]$/)&&(0===e||" "===f[e-1])){var o=f.slice(e).join("").match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(o){e+=o[0].length-1;var n=parseFloat(o[1]),s=void 0;switch(o[2]){case"ms":s=n;break;case"s":s=1e3*n;break;case"m":s=1e3*n*60}r(s/p.frameTimeFactor);break}}i=NotificationFactories_1.nextNotification(b(a)),r(1)}i&&m.push({frame:-1<v?v:h,notification:i}),h=t,d=e},p=this,o=0;o<i;o++)a(o),o=d;return m},c.prototype.createAnimator=function(){var t,n,s=this;if(this.runMode)return t=0,{animate:function(e){var r,t;if(n)throw new Error("animate() must not be called more than once within run()");if(/[|#]/.test(e))throw new Error("animate() must not complete or error");n=new Map;e=c.parseMarbles(e,void 0,void 0,void 0,!0);try{for(var i=__values(e),a=i.next();!a.done;a=i.next()){var o=a.value;s.schedule(function(){var r,e,t=s.now(),i=Array.from(n.values());n.clear();try{r=void 0;for(var a=__values(i),o=a.next();!o.done;o=a.next())(0,o.value)(t)}catch(e){r={error:e}}finally{try{o&&!o.done&&(e=a.return)&&e.call(a)}finally{if(r)throw r.error}}},o.frame)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(t=i.return)&&t.call(i)}finally{if(r)throw r.error}}},delegate:{requestAnimationFrame:function(e){var r;if(n)return r=++t,n.set(r,e),r;throw new Error("animate() was not called within run()")},cancelAnimationFrame:function(e){if(!n)throw new Error("animate() was not called within run()");n.delete(e)}}};throw new Error("animate() must only be used in run mode")},c.prototype.createDelegates=function(){var n=this,i=0,s=new Map,c=function(){var r=n.now(),e=Array.from(s.values()).filter(function(e){return e.due<=r}),t=e.filter(function(e){return"immediate"===e.type});if(0<t.length)a=(t=t[0]).handle,o=t.handler,s.delete(a);else{var t;if(0<(t=e.filter(function(e){return"interval"===e.type})).length)i=(t=t[0]).duration,o=t.handler,t.due=r+i,t.subscription=n.schedule(c,i);else{var i,a,o,t=e.filter(function(e){return"timeout"===e.type});if(!(0<t.length))throw new Error("Expected a due immediate or interval");a=(i=t[0]).handle,o=i.handler,s.delete(a)}}o()};return{immediate:{setImmediate:function(e){var r=++i;return s.set(r,{due:n.now(),duration:0,handle:r,handler:e,subscription:n.schedule(c,0),type:"immediate"}),r},clearImmediate:function(e){var r=s.get(e);r&&(r.subscription.unsubscribe(),s.delete(e))}},interval:{setInterval:function(e,r){void 0===r&&(r=0);var t=++i;return s.set(t,{due:n.now()+r,duration:r,handle:t,handler:e,subscription:n.schedule(c,r),type:"interval"}),t},clearInterval:function(e){var r=s.get(e);r&&(r.subscription.unsubscribe(),s.delete(e))}},timeout:{setTimeout:function(e,r){void 0===r&&(r=0);var t=++i;return s.set(t,{due:n.now()+r,duration:r,handle:t,handler:e,subscription:n.schedule(c,r),type:"timeout"}),t},clearTimeout:function(e){var r=s.get(e);r&&(r.subscription.unsubscribe(),s.delete(e))}}}},c.prototype.run=function(e){var r=c.frameTimeFactor,t=this.maxFrames,i=(c.frameTimeFactor=1,this.maxFrames=1/0,this.runMode=!0,this.createAnimator()),a=this.createDelegates(),a=(animationFrameProvider_1.animationFrameProvider.delegate=i.delegate,dateTimestampProvider_1.dateTimestampProvider.delegate=this,immediateProvider_1.immediateProvider.delegate=a.immediate,intervalProvider_1.intervalProvider.delegate=a.interval,timeoutProvider_1.timeoutProvider.delegate=a.timeout,{cold:(performanceTimestampProvider_1.performanceTimestampProvider.delegate=this).createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),time:this.createTime.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this),animate:i.animate});try{var o=e(a);return this.flush(),o}finally{c.frameTimeFactor=r,this.maxFrames=t,this.runMode=!1,animationFrameProvider_1.animationFrameProvider.delegate=void 0,dateTimestampProvider_1.dateTimestampProvider.delegate=void 0,immediateProvider_1.immediateProvider.delegate=void 0,intervalProvider_1.intervalProvider.delegate=void 0,timeoutProvider_1.timeoutProvider.delegate=void 0,performanceTimestampProvider_1.performanceTimestampProvider.delegate=void 0}},c.frameTimeFactor=10,c})(VirtualTimeScheduler_1.VirtualTimeScheduler);exports.TestScheduler=TestScheduler;