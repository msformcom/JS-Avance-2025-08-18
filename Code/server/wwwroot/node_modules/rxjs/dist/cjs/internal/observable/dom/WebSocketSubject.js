var __extends=this&&this.__extends||(()=>{var o=function(e,t){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}))(e,t)};return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}})(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},Subject_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebSocketSubject=void 0,require("../../Subject")),Subscriber_1=require("../../Subscriber"),Observable_1=require("../../Observable"),Subscription_1=require("../../Subscription"),ReplaySubject_1=require("../../ReplaySubject"),DEFAULT_WEBSOCKET_CONFIG={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",WebSocketSubject=(c=>{function r(e,t){var r=c.call(this)||this;if(r._socket=null,e instanceof Observable_1.Observable)r.destination=t,r.source=e;else{var o=r._config=__assign({},DEFAULT_WEBSOCKET_CONFIG);if(r._output=new Subject_1.Subject,"string"==typeof e)o.url=e;else for(var n in e)e.hasOwnProperty(n)&&(o[n]=e[n]);if(!o.WebSocketCtor&&WebSocket)o.WebSocketCtor=WebSocket;else if(!o.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new ReplaySubject_1.ReplaySubject}return r}return __extends(r,c),r.prototype.lift=function(e){var t=new r(this._config,this.destination);return t.operator=e,t.source=this,t},r.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new ReplaySubject_1.ReplaySubject),this._output=new Subject_1.Subject},r.prototype.multiplex=function(r,o,n){var c=this;return new Observable_1.Observable(function(t){try{c.next(r())}catch(e){t.error(e)}var e=c.subscribe({next:function(e){try{n(e)&&t.next(e)}catch(e){t.error(e)}},error:function(e){return t.error(e)},complete:function(){return t.complete()}});return function(){try{c.next(o())}catch(e){t.error(e)}e.unsubscribe()}})},r.prototype._connectSocket=function(){var r=this,e=this._config,t=e.WebSocketCtor,o=e.protocol,n=e.url,e=e.binaryType,c=this._output,s=null;try{s=o?new t(n,o):new t(n),this._socket=s,e&&(this._socket.binaryType=e)}catch(e){return void c.error(e)}var i=new Subscription_1.Subscription(function(){r._socket=null,s&&1===s.readyState&&s.close()});s.onopen=function(e){var t;r._socket?((t=r._config.openObserver)&&t.next(e),t=r.destination,r.destination=Subscriber_1.Subscriber.create(function(e){if(1===s.readyState)try{var t=r._config.serializer;s.send(t(e))}catch(e){r.destination.error(e)}},function(e){var t=r._config.closingObserver;t&&t.next(void 0),e&&e.code?s.close(e.code,e.reason):c.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT)),r._resetState()},function(){var e=r._config.closingObserver;e&&e.next(void 0),s.close(),r._resetState()}),t&&t instanceof ReplaySubject_1.ReplaySubject&&i.add(t.subscribe(r.destination))):(s.close(),r._resetState())},s.onerror=function(e){r._resetState(),c.error(e)},s.onclose=function(e){s===r._socket&&r._resetState();var t=r._config.closeObserver;t&&t.next(e),e.wasClean?c.complete():c.error(e)},s.onmessage=function(e){try{var t=r._config.deserializer;c.next(t(e))}catch(e){c.error(e)}}},r.prototype._subscribe=function(e){var t=this,r=this.source;return r?r.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(function(){var e=t._socket;0===t._output.observers.length&&(!e||1!==e.readyState&&0!==e.readyState||e.close(),t._resetState())}),e)},r.prototype.unsubscribe=function(){var e=this._socket;!e||1!==e.readyState&&0!==e.readyState||e.close(),this._resetState(),c.prototype.unsubscribe.call(this)},r})(Subject_1.AnonymousSubject);exports.WebSocketSubject=WebSocketSubject;