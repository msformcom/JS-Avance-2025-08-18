import{Observable}from"../Observable";import{innerFrom}from"../observable/innerFrom";import{Subject}from"../Subject";import{operate}from"../util/lift";import{createOperatorSubscriber,OperatorSubscriber}from"./OperatorSubscriber";function groupBy(l,o,f,v){return operate((e,n)=>{let u,s=(o&&"function"!=typeof o?{duration:f,element:u,connector:v}=o:u=o,new Map),t=e=>{s.forEach(e),e(n)},r=r=>t(e=>e.error(r)),a=0,p=!1,m=new OperatorSubscriber(n,e=>{try{let r=l(e),t=s.get(r);if(!t){s.set(r,t=v?v():new Subject);b=r,i=t,(c=new Observable(e=>{a++;let r=i.subscribe(e);return()=>{r.unsubscribe(),0==--a&&p&&m.unsubscribe()}})).key=b;var o=c;if(n.next(o),f){let e=createOperatorSubscriber(t,()=>{t.complete(),e?.unsubscribe()},void 0,void 0,()=>s.delete(r));m.add(innerFrom(f(o)).subscribe(e))}}t.next(u?u(e):e)}catch(e){r(e)}var b,i,c},()=>t(e=>e.complete()),r,()=>s.clear(),()=>(p=!0,0===a));e.subscribe(m)})}export{groupBy};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9yeGpzL3NyYy9pbnRlcm5hbC9vcGVyYXRvcnMvZ3JvdXBCeS50cyJdLCJuYW1lcyI6WyJPYnNlcnZhYmxlIiwiaW5uZXJGcm9tIiwiU3ViamVjdCIsIm9wZXJhdGUiLCJjcmVhdGVPcGVyYXRvclN1YnNjcmliZXIiLCJPcGVyYXRvclN1YnNjcmliZXIiLCJncm91cEJ5Iiwia2V5U2VsZWN0b3IiLCJlbGVtZW50T3JPcHRpb25zIiwiZHVyYXRpb24iLCJjb25uZWN0b3IiLCJzb3VyY2UiLCJzdWJzY3JpYmVyIiwibGV0IiwiZWxlbWVudCIsImdyb3VwcyIsIk1hcCIsIm5vdGlmeSIsImZvckVhY2giLCJjYiIsImhhbmRsZUVycm9yIiwiY29uc3VtZXIiLCJlcnJvciIsImVyciIsImFjdGl2ZUdyb3VwcyIsInRlYXJkb3duQXR0ZW1wdGVkIiwiZ3JvdXBCeVNvdXJjZVN1YnNjcmliZXIiLCJrZXkiLCJ2YWx1ZSIsImdyb3VwIiwiZ2V0Iiwic2V0IiwiZ3JvdXBTdWJqZWN0IiwicmVzdWx0IiwiaW5uZXJTdWIiLCJzdWJzY3JpYmUiLCJncm91cFN1YnNjcmliZXIiLCJ1bnN1YnNjcmliZSIsImdyb3VwZWQiLCJuZXh0IiwiZHVyYXRpb25TdWJzY3JpYmVyIiwiY29tcGxldGUiLCJ1bmRlZmluZWQiLCJkZWxldGUiLCJhZGQiLCJjbGVhciJdLCJtYXBwaW5ncyI6Ik9BQVNBLFVBQWlDLEtBQWYsdUJBQ2xCQyxTQUEwQyxLQUF6QixpQ0FDakJDLE9BQTJCLEtBQVosb0JBRWZDLE9BQTZCLEtBQWQsc0JBQ2ZDLHlCQUEwQkMsa0JBQWdELEtBQXRCLHVCQXVJdkQsU0FBVUMsUUFDZEMsRUFDQUMsRUFDQUMsRUFDQUMsR0FFQSxPQUFPUCxRQUFRLENBQUNRLEVBQVFDLEtBQ3RCQyxJQUFJQyxFQVFFQyxHQVBEUCxHQUFnRCxZQUE1QixPQUFPQSxFQUc3QixDQUFFQyxTQUFBQSxFQUFVSyxRQUFBQSxFQUFTSixVQUFBQSxDQUFTLEVBQUtGLEVBRnBDTSxFQUFVTixFQU1HLElBQUlRLEtBR2JDLEVBQVMsSUFDYkYsRUFBT0csUUFBUUMsQ0FBRSxFQUNqQkEsRUFBR1AsQ0FBVSxDQUNmLEVBSU1RLEVBQWMsR0FBY0gsRUFBTyxHQUFjSSxFQUFTQyxNQUFNQyxDQUFHLENBQUMsRUFHdEVDLEVBQWUsRUFHZkMsRUFBb0IsQ0FBQSxFQVNsQkMsRUFBMEIsSUFBSXJCLG1CQUNsQ08sRUFDQSxJQUlFLElBQ0UsSUFBTWUsRUFBTXBCLEVBQVlxQixDQUFLLEVBRXpCQyxFQUFRZCxFQUFPZSxJQUFJSCxDQUFHLEVBQzFCLEdBQUksQ0FBQ0UsRUFBTyxDQUVWZCxFQUFPZ0IsSUFBSUosRUFBTUUsRUFBUW5CLEVBQVlBLEVBQVMsRUFBSyxJQUFJUixPQUFlLEVBb0U3Q3lCLEVBL0RlQSxFQStEUEssRUEvRFlILEdBZ0U3Q0ksRUFBYyxJQUFJakMsV0FBYyxJQUNwQ3dCLENBQVksR0FDWixJQUFNVSxFQUFXRixFQUFhRyxVQUFVQyxDQUFlLEVBQ3ZELE1BQU8sS0FDTEYsRUFBU0csWUFBVyxFQUlELEdBQW5CLEVBQUViLEdBQXNCQyxHQUFxQkMsRUFBd0JXLFlBQVcsQ0FDbEYsQ0FDRixDQUFDLEdBQ01WLElBQU1BLEVBM0VQLElBQU1XLEVBNEVMTCxFQXpFRCxHQUZBckIsRUFBVzJCLEtBQUtELENBQU8sRUFFbkI3QixFQUFVLENBQ1osSUFBTStCLEVBQXFCcEMseUJBTXpCeUIsRUFDQSxLQUdFQSxFQUFPWSxTQUFRLEVBQ2ZELEdBQW9CSCxZQUFXLENBQ2pDLEVBRUFLLEtBQUFBLEVBR0FBLEtBQUFBLEVBRUEsSUFBTTNCLEVBQU80QixPQUFPaEIsQ0FBRyxDQUFDLEVBSTFCRCxFQUF3QmtCLElBQUkzQyxVQUFVUSxFQUFTNkIsQ0FBTyxDQUFDLEVBQUVILFVBQVVLLENBQWtCLENBQUMsQ0FDeEYsQ0FDRixDQUdBWCxFQUFNVSxLQUFLekIsRUFBVUEsRUFBUWMsQ0FBSyxFQUFJQSxDQUFLLENBRzdDLENBRkUsTUFBT0wsR0FDUEgsRUFBWUcsQ0FBRyxDQUNqQixDQTRCSixJQUFpQ0ksRUFBUUssRUFDakNDLENBNUJOLEVBRUEsSUFBTWhCLEVBQU8sR0FBY0ksRUFBU29CLFNBQVEsQ0FBRSxFQUU5Q3JCLEVBS0EsSUFBTUwsRUFBTzhCLE1BQUssRUFDbEIsS0FDRXBCLEVBQW9CLENBQUEsRUFJSSxJQUFqQkQsRUFDUixFQUlIYixFQUFPd0IsVUFBVVQsQ0FBdUIsQ0FzQjFDLENBQUMsQ0FDSCxRQXhJZ0JwQixPQXdJaEIiLCJmaWxlIjoibm9kZV9tb2R1bGVzL3J4anMvc3JjL2ludGVybmFsL29wZXJhdG9ycy9ncm91cEJ5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJy4uL09ic2VydmFibGUnO1xuaW1wb3J0IHsgaW5uZXJGcm9tIH0gZnJvbSAnLi4vb2JzZXJ2YWJsZS9pbm5lckZyb20nO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJy4uL1N1YmplY3QnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZUlucHV0LCBPYnNlcnZlciwgT3BlcmF0b3JGdW5jdGlvbiwgU3ViamVjdExpa2UgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBvcGVyYXRlIH0gZnJvbSAnLi4vdXRpbC9saWZ0JztcbmltcG9ydCB7IGNyZWF0ZU9wZXJhdG9yU3Vic2NyaWJlciwgT3BlcmF0b3JTdWJzY3JpYmVyIH0gZnJvbSAnLi9PcGVyYXRvclN1YnNjcmliZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJhc2ljR3JvdXBCeU9wdGlvbnM8SywgVD4ge1xuICBlbGVtZW50PzogdW5kZWZpbmVkO1xuICBkdXJhdGlvbj86IChncm91cGVkOiBHcm91cGVkT2JzZXJ2YWJsZTxLLCBUPikgPT4gT2JzZXJ2YWJsZUlucHV0PGFueT47XG4gIGNvbm5lY3Rvcj86ICgpID0+IFN1YmplY3RMaWtlPFQ+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdyb3VwQnlPcHRpb25zV2l0aEVsZW1lbnQ8SywgRSwgVD4ge1xuICBlbGVtZW50OiAodmFsdWU6IFQpID0+IEU7XG4gIGR1cmF0aW9uPzogKGdyb3VwZWQ6IEdyb3VwZWRPYnNlcnZhYmxlPEssIEU+KSA9PiBPYnNlcnZhYmxlSW5wdXQ8YW55PjtcbiAgY29ubmVjdG9yPzogKCkgPT4gU3ViamVjdExpa2U8RT47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBncm91cEJ5PFQsIEs+KGtleTogKHZhbHVlOiBUKSA9PiBLLCBvcHRpb25zOiBCYXNpY0dyb3VwQnlPcHRpb25zPEssIFQ+KTogT3BlcmF0b3JGdW5jdGlvbjxULCBHcm91cGVkT2JzZXJ2YWJsZTxLLCBUPj47XG5cbmV4cG9ydCBmdW5jdGlvbiBncm91cEJ5PFQsIEssIEU+KFxuICBrZXk6ICh2YWx1ZTogVCkgPT4gSyxcbiAgb3B0aW9uczogR3JvdXBCeU9wdGlvbnNXaXRoRWxlbWVudDxLLCBFLCBUPlxuKTogT3BlcmF0b3JGdW5jdGlvbjxULCBHcm91cGVkT2JzZXJ2YWJsZTxLLCBFPj47XG5cbmV4cG9ydCBmdW5jdGlvbiBncm91cEJ5PFQsIEsgZXh0ZW5kcyBUPihcbiAga2V5OiAodmFsdWU6IFQpID0+IHZhbHVlIGlzIEtcbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgR3JvdXBlZE9ic2VydmFibGU8dHJ1ZSwgSz4gfCBHcm91cGVkT2JzZXJ2YWJsZTxmYWxzZSwgRXhjbHVkZTxULCBLPj4+O1xuXG5leHBvcnQgZnVuY3Rpb24gZ3JvdXBCeTxULCBLPihrZXk6ICh2YWx1ZTogVCkgPT4gSyk6IE9wZXJhdG9yRnVuY3Rpb248VCwgR3JvdXBlZE9ic2VydmFibGU8SywgVD4+O1xuXG4vKipcbiAqIEBkZXByZWNhdGVkIHVzZSB0aGUgb3B0aW9ucyBwYXJhbWV0ZXIgaW5zdGVhZC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSz4oXG4gIGtleTogKHZhbHVlOiBUKSA9PiBLLFxuICBlbGVtZW50OiB2b2lkLFxuICBkdXJhdGlvbjogKGdyb3VwZWQ6IEdyb3VwZWRPYnNlcnZhYmxlPEssIFQ+KSA9PiBPYnNlcnZhYmxlPGFueT5cbik6IE9wZXJhdG9yRnVuY3Rpb248VCwgR3JvdXBlZE9ic2VydmFibGU8SywgVD4+O1xuXG4vKipcbiAqIEBkZXByZWNhdGVkIHVzZSB0aGUgb3B0aW9ucyBwYXJhbWV0ZXIgaW5zdGVhZC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdyb3VwQnk8VCwgSywgUj4oXG4gIGtleTogKHZhbHVlOiBUKSA9PiBLLFxuICBlbGVtZW50PzogKHZhbHVlOiBUKSA9PiBSLFxuICBkdXJhdGlvbj86IChncm91cGVkOiBHcm91cGVkT2JzZXJ2YWJsZTxLLCBSPikgPT4gT2JzZXJ2YWJsZTxhbnk+XG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEdyb3VwZWRPYnNlcnZhYmxlPEssIFI+PjtcblxuLyoqXG4gKiBHcm91cHMgdGhlIGl0ZW1zIGVtaXR0ZWQgYnkgYW4gT2JzZXJ2YWJsZSBhY2NvcmRpbmcgdG8gYSBzcGVjaWZpZWQgY3JpdGVyaW9uLFxuICogYW5kIGVtaXRzIHRoZXNlIGdyb3VwZWQgaXRlbXMgYXMgYEdyb3VwZWRPYnNlcnZhYmxlc2AsIG9uZVxuICoge0BsaW5rIEdyb3VwZWRPYnNlcnZhYmxlfSBwZXIgZ3JvdXAuXG4gKlxuICogIVtdKGdyb3VwQnkucG5nKVxuICpcbiAqIFdoZW4gdGhlIE9ic2VydmFibGUgZW1pdHMgYW4gaXRlbSwgYSBrZXkgaXMgY29tcHV0ZWQgZm9yIHRoaXMgaXRlbSB3aXRoIHRoZSBrZXkgZnVuY3Rpb24uXG4gKlxuICogSWYgYSB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9IGZvciB0aGlzIGtleSBleGlzdHMsIHRoaXMge0BsaW5rIEdyb3VwZWRPYnNlcnZhYmxlfSBlbWl0cy4gT3RoZXJ3aXNlLCBhIG5ld1xuICoge0BsaW5rIEdyb3VwZWRPYnNlcnZhYmxlfSBmb3IgdGhpcyBrZXkgaXMgY3JlYXRlZCBhbmQgZW1pdHMuXG4gKlxuICogQSB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9IHJlcHJlc2VudHMgdmFsdWVzIGJlbG9uZ2luZyB0byB0aGUgc2FtZSBncm91cCByZXByZXNlbnRlZCBieSBhIGNvbW1vbiBrZXkuIFRoZSBjb21tb25cbiAqIGtleSBpcyBhdmFpbGFibGUgYXMgdGhlIGBrZXlgIGZpZWxkIG9mIGEge0BsaW5rIEdyb3VwZWRPYnNlcnZhYmxlfSBpbnN0YW5jZS5cbiAqXG4gKiBUaGUgZWxlbWVudHMgZW1pdHRlZCBieSB7QGxpbmsgR3JvdXBlZE9ic2VydmFibGV9cyBhcmUgYnkgZGVmYXVsdCB0aGUgaXRlbXMgZW1pdHRlZCBieSB0aGUgT2JzZXJ2YWJsZSwgb3IgZWxlbWVudHNcbiAqIHJldHVybmVkIGJ5IHRoZSBlbGVtZW50IGZ1bmN0aW9uLlxuICpcbiAqICMjIEV4YW1wbGVzXG4gKlxuICogR3JvdXAgb2JqZWN0cyBieSBgaWRgIGFuZCByZXR1cm4gYXMgYXJyYXlcbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgb2YsIGdyb3VwQnksIG1lcmdlTWFwLCByZWR1Y2UgfSBmcm9tICdyeGpzJztcbiAqXG4gKiBvZihcbiAqICAgeyBpZDogMSwgbmFtZTogJ0phdmFTY3JpcHQnIH0sXG4gKiAgIHsgaWQ6IDIsIG5hbWU6ICdQYXJjZWwnIH0sXG4gKiAgIHsgaWQ6IDIsIG5hbWU6ICd3ZWJwYWNrJyB9LFxuICogICB7IGlkOiAxLCBuYW1lOiAnVHlwZVNjcmlwdCcgfSxcbiAqICAgeyBpZDogMywgbmFtZTogJ1RTTGludCcgfVxuICogKS5waXBlKFxuICogICBncm91cEJ5KHAgPT4gcC5pZCksXG4gKiAgIG1lcmdlTWFwKGdyb3VwJCA9PiBncm91cCQucGlwZShyZWR1Y2UoKGFjYywgY3VyKSA9PiBbLi4uYWNjLCBjdXJdLCBbXSkpKVxuICogKVxuICogLnN1YnNjcmliZShwID0+IGNvbnNvbGUubG9nKHApKTtcbiAqXG4gKiAvLyBkaXNwbGF5czpcbiAqIC8vIFt7IGlkOiAxLCBuYW1lOiAnSmF2YVNjcmlwdCcgfSwgeyBpZDogMSwgbmFtZTogJ1R5cGVTY3JpcHQnfV1cbiAqIC8vIFt7IGlkOiAyLCBuYW1lOiAnUGFyY2VsJyB9LCB7IGlkOiAyLCBuYW1lOiAnd2VicGFjayd9XVxuICogLy8gW3sgaWQ6IDMsIG5hbWU6ICdUU0xpbnQnIH1dXG4gKiBgYGBcbiAqXG4gKiBQaXZvdCBkYXRhIG9uIHRoZSBgaWRgIGZpZWxkXG4gKlxuICogYGBgdHNcbiAqIGltcG9ydCB7IG9mLCBncm91cEJ5LCBtZXJnZU1hcCwgcmVkdWNlLCBtYXAgfSBmcm9tICdyeGpzJztcbiAqXG4gKiBvZihcbiAqICAgeyBpZDogMSwgbmFtZTogJ0phdmFTY3JpcHQnIH0sXG4gKiAgIHsgaWQ6IDIsIG5hbWU6ICdQYXJjZWwnIH0sXG4gKiAgIHsgaWQ6IDIsIG5hbWU6ICd3ZWJwYWNrJyB9LFxuICogICB7IGlkOiAxLCBuYW1lOiAnVHlwZVNjcmlwdCcgfSxcbiAqICAgeyBpZDogMywgbmFtZTogJ1RTTGludCcgfVxuICogKS5waXBlKFxuICogICBncm91cEJ5KHAgPT4gcC5pZCwgeyBlbGVtZW50OiBwID0+IHAubmFtZSB9KSxcbiAqICAgbWVyZ2VNYXAoZ3JvdXAkID0+IGdyb3VwJC5waXBlKHJlZHVjZSgoYWNjLCBjdXIpID0+IFsuLi5hY2MsIGN1cl0sIFtgJHsgZ3JvdXAkLmtleSB9YF0pKSksXG4gKiAgIG1hcChhcnIgPT4gKHsgaWQ6IHBhcnNlSW50KGFyclswXSwgMTApLCB2YWx1ZXM6IGFyci5zbGljZSgxKSB9KSlcbiAqIClcbiAqIC5zdWJzY3JpYmUocCA9PiBjb25zb2xlLmxvZyhwKSk7XG4gKlxuICogLy8gZGlzcGxheXM6XG4gKiAvLyB7IGlkOiAxLCB2YWx1ZXM6IFsgJ0phdmFTY3JpcHQnLCAnVHlwZVNjcmlwdCcgXSB9XG4gKiAvLyB7IGlkOiAyLCB2YWx1ZXM6IFsgJ1BhcmNlbCcsICd3ZWJwYWNrJyBdIH1cbiAqIC8vIHsgaWQ6IDMsIHZhbHVlczogWyAnVFNMaW50JyBdIH1cbiAqIGBgYFxuICpcbiAqIEBwYXJhbSBrZXkgQSBmdW5jdGlvbiB0aGF0IGV4dHJhY3RzIHRoZSBrZXlcbiAqIGZvciBlYWNoIGl0ZW0uXG4gKiBAcGFyYW0gZWxlbWVudCBBIGZ1bmN0aW9uIHRoYXQgZXh0cmFjdHMgdGhlXG4gKiByZXR1cm4gZWxlbWVudCBmb3IgZWFjaCBpdGVtLlxuICogQHBhcmFtIGR1cmF0aW9uXG4gKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhbiBPYnNlcnZhYmxlIHRvIGRldGVybWluZSBob3cgbG9uZyBlYWNoIGdyb3VwIHNob3VsZFxuICogZXhpc3QuXG4gKiBAcGFyYW0gY29ubmVjdG9yIEZhY3RvcnkgZnVuY3Rpb24gdG8gY3JlYXRlIGFuXG4gKiBpbnRlcm1lZGlhdGUgU3ViamVjdCB0aHJvdWdoIHdoaWNoIGdyb3VwZWQgZWxlbWVudHMgYXJlIGVtaXR0ZWQuXG4gKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIE9ic2VydmFibGUgdGhhdCBlbWl0cyBHcm91cGVkT2JzZXJ2YWJsZXMsXG4gKiBlYWNoIG9mIHdoaWNoIGNvcnJlc3BvbmRzIHRvIGEgdW5pcXVlIGtleSB2YWx1ZSBhbmQgZWFjaCBvZiB3aGljaCBlbWl0c1xuICogdGhvc2UgaXRlbXMgZnJvbSB0aGUgc291cmNlIE9ic2VydmFibGUgdGhhdCBzaGFyZSB0aGF0IGtleSB2YWx1ZS5cbiAqXG4gKiBAZGVwcmVjYXRlZCBVc2UgdGhlIG9wdGlvbnMgcGFyYW1ldGVyIGluc3RlYWQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBncm91cEJ5PFQsIEssIFI+KFxuICBrZXk6ICh2YWx1ZTogVCkgPT4gSyxcbiAgZWxlbWVudD86ICh2YWx1ZTogVCkgPT4gUixcbiAgZHVyYXRpb24/OiAoZ3JvdXBlZDogR3JvdXBlZE9ic2VydmFibGU8SywgUj4pID0+IE9ic2VydmFibGU8YW55PixcbiAgY29ubmVjdG9yPzogKCkgPT4gU3ViamVjdDxSPlxuKTogT3BlcmF0b3JGdW5jdGlvbjxULCBHcm91cGVkT2JzZXJ2YWJsZTxLLCBSPj47XG5cbi8vIEltcGxcbmV4cG9ydCBmdW5jdGlvbiBncm91cEJ5PFQsIEssIFI+KFxuICBrZXlTZWxlY3RvcjogKHZhbHVlOiBUKSA9PiBLLFxuICBlbGVtZW50T3JPcHRpb25zPzogKCh2YWx1ZTogYW55KSA9PiBhbnkpIHwgdm9pZCB8IEJhc2ljR3JvdXBCeU9wdGlvbnM8SywgVD4gfCBHcm91cEJ5T3B0aW9uc1dpdGhFbGVtZW50PEssIFIsIFQ+LFxuICBkdXJhdGlvbj86IChncm91cGVkOiBHcm91cGVkT2JzZXJ2YWJsZTxhbnksIGFueT4pID0+IE9ic2VydmFibGVJbnB1dDxhbnk+LFxuICBjb25uZWN0b3I/OiAoKSA9PiBTdWJqZWN0TGlrZTxhbnk+XG4pOiBPcGVyYXRvckZ1bmN0aW9uPFQsIEdyb3VwZWRPYnNlcnZhYmxlPEssIFI+PiB7XG4gIHJldHVybiBvcGVyYXRlKChzb3VyY2UsIHN1YnNjcmliZXIpID0+IHtcbiAgICBsZXQgZWxlbWVudDogKCh2YWx1ZTogYW55KSA9PiBhbnkpIHwgdm9pZDtcbiAgICBpZiAoIWVsZW1lbnRPck9wdGlvbnMgfHwgdHlwZW9mIGVsZW1lbnRPck9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50T3JPcHRpb25zIGFzICgodmFsdWU6IGFueSkgPT4gYW55KTtcbiAgICB9IGVsc2Uge1xuICAgICAgKHsgZHVyYXRpb24sIGVsZW1lbnQsIGNvbm5lY3RvciB9ID0gZWxlbWVudE9yT3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLy8gQSBsb29rdXAgZm9yIHRoZSBncm91cHMgdGhhdCB3ZSBoYXZlIHNvIGZhci5cbiAgICBjb25zdCBncm91cHMgPSBuZXcgTWFwPEssIFN1YmplY3RMaWtlPGFueT4+KCk7XG5cbiAgICAvLyBVc2VkIGZvciBub3RpZnlpbmcgYWxsIGdyb3VwcyBhbmQgdGhlIHN1YnNjcmliZXIgaW4gdGhlIHNhbWUgd2F5LlxuICAgIGNvbnN0IG5vdGlmeSA9IChjYjogKGdyb3VwOiBPYnNlcnZlcjxhbnk+KSA9PiB2b2lkKSA9PiB7XG4gICAgICBncm91cHMuZm9yRWFjaChjYik7XG4gICAgICBjYihzdWJzY3JpYmVyKTtcbiAgICB9O1xuXG4gICAgLy8gVXNlZCB0byBoYW5kbGUgZXJyb3JzIGZyb20gdGhlIHNvdXJjZSwgQU5EIGVycm9ycyB0aGF0IG9jY3VyIGR1cmluZyB0aGVcbiAgICAvLyBuZXh0IGNhbGwgZnJvbSB0aGUgc291cmNlLlxuICAgIGNvbnN0IGhhbmRsZUVycm9yID0gKGVycjogYW55KSA9PiBub3RpZnkoKGNvbnN1bWVyKSA9PiBjb25zdW1lci5lcnJvcihlcnIpKTtcblxuICAgIC8vIFRoZSBudW1iZXIgb2YgYWN0aXZlbHkgc3Vic2NyaWJlZCBncm91cHNcbiAgICBsZXQgYWN0aXZlR3JvdXBzID0gMDtcblxuICAgIC8vIFdoZXRoZXIgb3Igbm90IHRlYXJkb3duIHdhcyBhdHRlbXB0ZWQgb24gdGhpcyBzdWJzY3JpcHRpb24uXG4gICAgbGV0IHRlYXJkb3duQXR0ZW1wdGVkID0gZmFsc2U7XG5cbiAgICAvLyBDYXB0dXJpbmcgYSByZWZlcmVuY2UgdG8gdGhpcywgYmVjYXVzZSB3ZSBuZWVkIGEgaGFuZGxlIHRvIGl0XG4gICAgLy8gaW4gYGNyZWF0ZUdyb3VwZWRPYnNlcnZhYmxlYCBiZWxvdy4gVGhpcyBpcyB3aGF0IHdlIHVzZSB0b1xuICAgIC8vIHN1YnNjcmliZSB0byBvdXIgc291cmNlIG9ic2VydmFibGUuIFRoaXMgc29tZXRpbWVzIG5lZWRzIHRvIGJlIHVuc3Vic2NyaWJlZFxuICAgIC8vIG91dC1vZi1iYW5kIHdpdGggb3VyIGBzdWJzY3JpYmVyYCB3aGljaCBpcyB0aGUgZG93bnN0cmVhbSBzdWJzY3JpYmVyLCBvciBkZXN0aW5hdGlvbixcbiAgICAvLyBpbiBjYXNlcyB3aGVyZSBhIHVzZXIgdW5zdWJzY3JpYmVzIGZyb20gdGhlIG1haW4gcmVzdWx0aW5nIHN1YnNjcmlwdGlvbiwgYnV0XG4gICAgLy8gc3RpbGwgaGFzIGdyb3VwcyBmcm9tIHRoaXMgc3Vic2NyaXB0aW9uIHN1YnNjcmliZWQgYW5kIHdvdWxkIGV4cGVjdCB2YWx1ZXMgZnJvbSBpdFxuICAgIC8vIENvbnNpZGVyOiAgYHNvdXJjZS5waXBlKGdyb3VwQnkoZm4pLCB0YWtlKDIpKWAuXG4gICAgY29uc3QgZ3JvdXBCeVNvdXJjZVN1YnNjcmliZXIgPSBuZXcgT3BlcmF0b3JTdWJzY3JpYmVyKFxuICAgICAgc3Vic2NyaWJlcixcbiAgICAgICh2YWx1ZTogVCkgPT4ge1xuICAgICAgICAvLyBCZWNhdXNlIHdlIGhhdmUgdG8gbm90aWZ5IGFsbCBncm91cHMgb2YgYW55IGVycm9ycyB0aGF0IG9jY3VyIGluIGhlcmUsXG4gICAgICAgIC8vIHdlIGhhdmUgdG8gYWRkIG91ciBvd24gdHJ5L2NhdGNoIHRvIGVuc3VyZSB0aGF0IHRob3NlIGVycm9ycyBhcmUgcHJvcGFnYXRlZC5cbiAgICAgICAgLy8gT3BlcmF0b3JTdWJzY3JpYmVyIHdpbGwgb25seSBzZW5kIHRoZSBlcnJvciB0byB0aGUgbWFpbiBzdWJzY3JpYmVyLlxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGtleSA9IGtleVNlbGVjdG9yKHZhbHVlKTtcblxuICAgICAgICAgIGxldCBncm91cCA9IGdyb3Vwcy5nZXQoa2V5KTtcbiAgICAgICAgICBpZiAoIWdyb3VwKSB7XG4gICAgICAgICAgICAvLyBDcmVhdGUgb3VyIGdyb3VwIHN1YmplY3RcbiAgICAgICAgICAgIGdyb3Vwcy5zZXQoa2V5LCAoZ3JvdXAgPSBjb25uZWN0b3IgPyBjb25uZWN0b3IoKSA6IG5ldyBTdWJqZWN0PGFueT4oKSkpO1xuXG4gICAgICAgICAgICAvLyBFbWl0IHRoZSBncm91cGVkIG9ic2VydmFibGUuIE5vdGUgdGhhdCB3ZSBjYW4ndCBkbyBhIHNpbXBsZSBgYXNPYnNlcnZhYmxlKClgIGhlcmUsXG4gICAgICAgICAgICAvLyBiZWNhdXNlIHRoZSBncm91cGVkIG9ic2VydmFibGUgaGFzIHNwZWNpYWwgc2VtYW50aWNzIGFyb3VuZCByZWZlcmVuY2UgY291bnRpbmdcbiAgICAgICAgICAgIC8vIHRvIGVuc3VyZSB3ZSBkb24ndCBzZXZlciBvdXIgY29ubmVjdGlvbiB0byB0aGUgc291cmNlIHByZW1hdHVyZWx5LlxuICAgICAgICAgICAgY29uc3QgZ3JvdXBlZCA9IGNyZWF0ZUdyb3VwZWRPYnNlcnZhYmxlKGtleSwgZ3JvdXApO1xuICAgICAgICAgICAgc3Vic2NyaWJlci5uZXh0KGdyb3VwZWQpO1xuXG4gICAgICAgICAgICBpZiAoZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb25TdWJzY3JpYmVyID0gY3JlYXRlT3BlcmF0b3JTdWJzY3JpYmVyKFxuICAgICAgICAgICAgICAgIC8vIFByb3ZpZGluZyB0aGUgZ3JvdXAgaGVyZSBlbnN1cmVzIHRoYXQgaXQgaXMgZGlzcG9zZWQgb2YgLS0gdmlhIGB1bnN1YnNjcmliZWAgLS1cbiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSBkdXJhdGlvbiBzdWJzY3JpcHRpb24gaXMgdG9ybiBkb3duLiBUaGF0IGlzIGltcG9ydGFudCwgYmVjYXVzZSB0aGVuXG4gICAgICAgICAgICAgICAgLy8gaWYgc29tZW9uZSBob2xkcyBhIGhhbmRsZSB0byB0aGUgZ3JvdXBlZCBvYnNlcnZhYmxlIGFuZCB0cmllcyB0byBzdWJzY3JpYmUgdG8gaXRcbiAgICAgICAgICAgICAgICAvLyBhZnRlciB0aGUgY29ubmVjdGlvbiB0byB0aGUgc291cmNlIGhhcyBiZWVuIHNldmVyZWQsIHRoZXkgd2lsbCBnZXQgYW5cbiAgICAgICAgICAgICAgICAvLyBgT2JqZWN0VW5zdWJzY3JpYmVkRXJyb3JgIGFuZCBrbm93IHRoZXkgY2FuJ3QgcG9zc2libHkgZ2V0IGFueSBub3RpZmljYXRpb25zLlxuICAgICAgICAgICAgICAgIGdyb3VwIGFzIGFueSxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAvLyBPdXIgZHVyYXRpb24gbm90aWZpZWQhIFdlIGNhbiBjb21wbGV0ZSB0aGUgZ3JvdXAuXG4gICAgICAgICAgICAgICAgICAvLyBUaGUgZ3JvdXAgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIG1hcCBpbiB0aGUgZmluYWxpemF0aW9uIHBoYXNlLlxuICAgICAgICAgICAgICAgICAgZ3JvdXAhLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICBkdXJhdGlvblN1YnNjcmliZXI/LnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvLyBDb21wbGV0aW9ucyBhcmUgYWxzbyBzZW50IHRvIHRoZSBncm91cCwgYnV0IGp1c3QgdGhlIGdyb3VwLlxuICAgICAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAvLyBFcnJvcnMgb24gdGhlIGR1cmF0aW9uIHN1YnNjcmliZXIgYXJlIHNlbnQgdG8gdGhlIGdyb3VwXG4gICAgICAgICAgICAgICAgLy8gYnV0IG9ubHkgdGhlIGdyb3VwLiBUaGV5IGFyZSBub3Qgc2VudCB0byB0aGUgbWFpbiBzdWJzY3JpcHRpb24uXG4gICAgICAgICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIC8vIEZpbmFsaXphdGlvbjogUmVtb3ZlIHRoaXMgZ3JvdXAgZnJvbSBvdXIgbWFwLlxuICAgICAgICAgICAgICAgICgpID0+IGdyb3Vwcy5kZWxldGUoa2V5KVxuICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgIC8vIFN0YXJ0IG91ciBkdXJhdGlvbiBub3RpZmllci5cbiAgICAgICAgICAgICAgZ3JvdXBCeVNvdXJjZVN1YnNjcmliZXIuYWRkKGlubmVyRnJvbShkdXJhdGlvbihncm91cGVkKSkuc3Vic2NyaWJlKGR1cmF0aW9uU3Vic2NyaWJlcikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIFNlbmQgdGhlIHZhbHVlIHRvIG91ciBncm91cC5cbiAgICAgICAgICBncm91cC5uZXh0KGVsZW1lbnQgPyBlbGVtZW50KHZhbHVlKSA6IHZhbHVlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgaGFuZGxlRXJyb3IoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIC8vIFNvdXJjZSBjb21wbGV0ZXMuXG4gICAgICAoKSA9PiBub3RpZnkoKGNvbnN1bWVyKSA9PiBjb25zdW1lci5jb21wbGV0ZSgpKSxcbiAgICAgIC8vIEVycm9yIGZyb20gdGhlIHNvdXJjZS5cbiAgICAgIGhhbmRsZUVycm9yLFxuICAgICAgLy8gRnJlZSB1cCBtZW1vcnkuXG4gICAgICAvLyBXaGVuIHRoZSBzb3VyY2Ugc3Vic2NyaXB0aW9uIGlzIF9maW5hbGx5XyB0b3JuIGRvd24sIHJlbGVhc2UgdGhlIHN1YmplY3RzIGFuZCBrZXlzXG4gICAgICAvLyBpbiBvdXIgZ3JvdXBzIE1hcCwgdGhleSBtYXkgYmUgcXVpdGUgbGFyZ2UgYW5kIHdlIGRvbid0IHdhbnQgdG8ga2VlcCB0aGVtIGFyb3VuZCBpZiB3ZVxuICAgICAgLy8gZG9uJ3QgaGF2ZSB0by5cbiAgICAgICgpID0+IGdyb3Vwcy5jbGVhcigpLFxuICAgICAgKCkgPT4ge1xuICAgICAgICB0ZWFyZG93bkF0dGVtcHRlZCA9IHRydWU7XG4gICAgICAgIC8vIFdlIG9ubHkga2lsbCBvdXIgc3Vic2NyaXB0aW9uIHRvIHRoZSBzb3VyY2UgaWYgd2UgaGF2ZVxuICAgICAgICAvLyBubyBhY3RpdmUgZ3JvdXBzLiBBcyBzdGF0ZWQgYWJvdmUsIGNvbnNpZGVyIHRoaXMgc2NlbmFyaW86XG4gICAgICAgIC8vIHNvdXJjZSQucGlwZShncm91cEJ5KGZuKSwgdGFrZSgyKSkuXG4gICAgICAgIHJldHVybiBhY3RpdmVHcm91cHMgPT09IDA7XG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIFN1YnNjcmliZSB0byB0aGUgc291cmNlXG4gICAgc291cmNlLnN1YnNjcmliZShncm91cEJ5U291cmNlU3Vic2NyaWJlcik7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIHRoZSBhY3R1YWwgZ3JvdXBlZCBvYnNlcnZhYmxlIHJldHVybmVkLlxuICAgICAqIEBwYXJhbSBrZXkgVGhlIGtleSBvZiB0aGUgZ3JvdXBcbiAgICAgKiBAcGFyYW0gZ3JvdXBTdWJqZWN0IFRoZSBzdWJqZWN0IHRoYXQgZnVlbHMgdGhlIGdyb3VwXG4gICAgICovXG4gICAgZnVuY3Rpb24gY3JlYXRlR3JvdXBlZE9ic2VydmFibGUoa2V5OiBLLCBncm91cFN1YmplY3Q6IFN1YmplY3RMaWtlPGFueT4pIHtcbiAgICAgIGNvbnN0IHJlc3VsdDogYW55ID0gbmV3IE9ic2VydmFibGU8VD4oKGdyb3VwU3Vic2NyaWJlcikgPT4ge1xuICAgICAgICBhY3RpdmVHcm91cHMrKztcbiAgICAgICAgY29uc3QgaW5uZXJTdWIgPSBncm91cFN1YmplY3Quc3Vic2NyaWJlKGdyb3VwU3Vic2NyaWJlcik7XG4gICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgaW5uZXJTdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAvLyBXZSBjYW4ga2lsbCB0aGUgc3Vic2NyaXB0aW9uIHRvIG91ciBzb3VyY2UgaWYgd2Ugbm93IGhhdmUgbm8gbW9yZVxuICAgICAgICAgIC8vIGFjdGl2ZSBncm91cHMgc3Vic2NyaWJlZCwgYW5kIGEgZmluYWxpemF0aW9uIHdhcyBhbHJlYWR5IGF0dGVtcHRlZCBvblxuICAgICAgICAgIC8vIHRoZSBzb3VyY2UuXG4gICAgICAgICAgLS1hY3RpdmVHcm91cHMgPT09IDAgJiYgdGVhcmRvd25BdHRlbXB0ZWQgJiYgZ3JvdXBCeVNvdXJjZVN1YnNjcmliZXIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgICAgcmVzdWx0LmtleSA9IGtleTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICB9KTtcbn1cblxuLyoqXG4gKiBBbiBvYnNlcnZhYmxlIG9mIHZhbHVlcyB0aGF0IGlzIHRoZSBlbWl0dGVkIGJ5IHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgZ3JvdXBCeX0gb3BlcmF0b3IsXG4gKiBjb250YWlucyBhIGBrZXlgIHByb3BlcnR5IGZvciB0aGUgZ3JvdXBpbmcuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR3JvdXBlZE9ic2VydmFibGU8SywgVD4gZXh0ZW5kcyBPYnNlcnZhYmxlPFQ+IHtcbiAgLyoqXG4gICAqIFRoZSBrZXkgdmFsdWUgZm9yIHRoZSBncm91cGVkIG5vdGlmaWNhdGlvbnMuXG4gICAqL1xuICByZWFkb25seSBrZXk6IEs7XG59XG4iXX0=
