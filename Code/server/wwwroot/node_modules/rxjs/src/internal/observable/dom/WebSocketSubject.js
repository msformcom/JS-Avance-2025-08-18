import{Subject,AnonymousSubject}from"../../Subject";import{Subscriber}from"../../Subscriber";import{Observable}from"../../Observable";import{Subscription}from"../../Subscription";import{ReplaySubject}from"../../ReplaySubject";let DEFAULT_WEBSOCKET_CONFIG={url:"",deserializer:e=>JSON.parse(e.data),serializer:e=>JSON.stringify(e)},WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }";class WebSocketSubject extends AnonymousSubject{constructor(e,t){if(super(),this._socket=null,e instanceof Observable)this.destination=t,this.source=e;else{var r=this._config={...DEFAULT_WEBSOCKET_CONFIG};if(this._output=new Subject,"string"==typeof e)r.url=e;else for(var s in e)e.hasOwnProperty(s)&&(r[s]=e[s]);if(!r.WebSocketCtor&&WebSocket)r.WebSocketCtor=WebSocket;else if(!r.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new ReplaySubject}}lift(e){var t=new WebSocketSubject(this._config,this.destination);return t.operator=e,t.source=this,t}_resetState(){this._socket=null,this.source||(this.destination=new ReplaySubject),this._output=new Subject}multiplex(r,s,o){let i=this;return new Observable(t=>{try{i.next(r())}catch(e){t.error(e)}let e=i.subscribe({next:e=>{try{o(e)&&t.next(e)}catch(e){t.error(e)}},error:e=>t.error(e),complete:()=>t.complete()});return()=>{try{i.next(s())}catch(e){t.error(e)}e.unsubscribe()}})}_connectSocket(){var{WebSocketCtor:e,protocol:t,url:r,binaryType:s}=this._config;let o=this._output,i=null;try{i=t?new e(r,t):new e(r),this._socket=i,s&&(this._socket.binaryType=s)}catch(e){return void o.error(e)}let c=new Subscription(()=>{this._socket=null,i&&1===i.readyState&&i.close()});i.onopen=e=>{var t=this._socket;t?(t=this._config.openObserver,t&&t.next(e),t=this.destination,this.destination=Subscriber.create(e=>{if(1===i.readyState)try{var t=this._config.serializer;i.send(t(e))}catch(e){this.destination.error(e)}},e=>{var t=this._config.closingObserver;t&&t.next(void 0),e&&e.code?i.close(e.code,e.reason):o.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT)),this._resetState()},()=>{var e=this._config.closingObserver;e&&e.next(void 0),i.close(),this._resetState()}),t&&t instanceof ReplaySubject&&c.add(t.subscribe(this.destination))):(i.close(),this._resetState())},i.onerror=e=>{this._resetState(),o.error(e)},i.onclose=e=>{i===this._socket&&this._resetState();var t=this._config.closeObserver;t&&t.next(e),e.wasClean?o.complete():o.error(e)},i.onmessage=e=>{try{var t=this._config.deserializer;o.next(t(e))}catch(e){o.error(e)}}}_subscribe(e){var t=this.source;return t?t.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{var e=this._socket;0===this._output.observers.length&&(!e||1!==e.readyState&&0!==e.readyState||e.close(),this._resetState())}),e)}unsubscribe(){var e=this._socket;!e||1!==e.readyState&&0!==e.readyState||e.close(),this._resetState(),super.unsubscribe()}}export{WebSocketSubject};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9yeGpzL3NyYy9pbnRlcm5hbC9vYnNlcnZhYmxlL2RvbS9XZWJTb2NrZXRTdWJqZWN0LnRzIl0sIm5hbWVzIjpbIlN1YmplY3QiLCJBbm9ueW1vdXNTdWJqZWN0IiwiU3Vic2NyaWJlciIsIk9ic2VydmFibGUiLCJTdWJzY3JpcHRpb24iLCJSZXBsYXlTdWJqZWN0IiwiREVGQVVMVF9XRUJTT0NLRVRfQ09ORklHIiwidXJsIiwiZGVzZXJpYWxpemVyIiwiSlNPTiIsInBhcnNlIiwiZSIsImRhdGEiLCJzZXJpYWxpemVyIiwic3RyaW5naWZ5IiwidmFsdWUiLCJXRUJTT0NLRVRTVUJKRUNUX0lOVkFMSURfRVJST1JfT0JKRUNUIiwiV2ViU29ja2V0U3ViamVjdCIsImNvbnN0cnVjdG9yIiwidXJsQ29uZmlnT3JTb3VyY2UiLCJkZXN0aW5hdGlvbiIsInN1cGVyIiwidGhpcyIsIl9zb2NrZXQiLCJzb3VyY2UiLCJjb25maWciLCJfY29uZmlnIiwiX291dHB1dCIsImtleSIsImhhc093blByb3BlcnR5IiwiV2ViU29ja2V0Q3RvciIsIldlYlNvY2tldCIsIkVycm9yIiwibGlmdCIsIm9wZXJhdG9yIiwic29jayIsIl9yZXNldFN0YXRlIiwibXVsdGlwbGV4Iiwic3ViTXNnIiwidW5zdWJNc2ciLCJtZXNzYWdlRmlsdGVyIiwic2VsZiIsIm5leHQiLCJlcnIiLCJvYnNlcnZlciIsImVycm9yIiwic3Vic2NyaXB0aW9uIiwic3Vic2NyaWJlIiwieCIsImNvbXBsZXRlIiwidW5zdWJzY3JpYmUiLCJfY29ubmVjdFNvY2tldCIsInByb3RvY29sIiwiYmluYXJ5VHlwZSIsInNvY2tldCIsInJlYWR5U3RhdGUiLCJjbG9zZSIsIm9ub3BlbiIsIm9wZW5PYnNlcnZlciIsImV2dCIsInF1ZXVlIiwiY3JlYXRlIiwic2VuZCIsImNsb3NpbmdPYnNlcnZlciIsInVuZGVmaW5lZCIsImNvZGUiLCJyZWFzb24iLCJUeXBlRXJyb3IiLCJhZGQiLCJvbmVycm9yIiwib25jbG9zZSIsImNsb3NlT2JzZXJ2ZXIiLCJ3YXNDbGVhbiIsIm9ubWVzc2FnZSIsIl9zdWJzY3JpYmUiLCJzdWJzY3JpYmVyIiwib2JzZXJ2ZXJzIiwibGVuZ3RoIl0sIm1hcHBpbmdzIjoiT0FBU0EsUUFBU0MsZ0JBQXVDLEtBQWYsdUJBQ2pDQyxVQUFvQyxLQUFsQiwwQkFDbEJDLFVBQW9DLEtBQWxCLDBCQUNsQkMsWUFBd0MsS0FBcEIsNEJBRXBCQyxhQUEwQyxLQUFyQixzQkE0STlCLElBQU1DLHlCQUF3RCxDQUM1REMsSUFBSyxHQUNMQyxhQUFjLEdBQXFCQyxLQUFLQyxNQUFNQyxFQUFFQyxJQUFJLEVBQ3BEQyxXQUFZLEdBQWdCSixLQUFLSyxVQUFVQyxDQUFLLEMsRUFHNUNDLHNDQUNKLDBJQUlXQyx5QkFBNEJoQixpQkFVdkNpQixZQUFZQyxFQUF1RUMsR0FFakYsR0FEQUMsTUFBSyxFQUhDQyxLQUFBQyxRQUE0QixLQUk5QkosYUFBNkJoQixXQUMvQm1CLEtBQUtGLFlBQWNBLEVBQ25CRSxLQUFLRSxPQUFTTCxNQUNULENBQ0wsSUFBTU0sRUFBVUgsS0FBS0ksUUFBVSxDQUFFLEdBQUdwQix3QkFBd0IsRUFFNUQsR0FEQWdCLEtBQUtLLFFBQVUsSUFBSTNCLFFBQ2MsVUFBN0IsT0FBT21CLEVBQ1RNLEVBQU9sQixJQUFNWSxPQUViLElBQUssSUFBTVMsS0FBT1QsRUFDWkEsRUFBa0JVLGVBQWVELENBQUcsSUFDckNILEVBQWVHLEdBQVFULEVBQTBCUyxJQUt4RCxHQUFJLENBQUNILEVBQU9LLGVBQWlCQyxVQUMzQk4sRUFBT0ssY0FBZ0JDLGVBQ2xCLEdBQUksQ0FBQ04sRUFBT0ssY0FDakIsTUFBTSxJQUFJRSxNQUFNLHVDQUF1QyxFQUV6RFYsS0FBS0YsWUFBYyxJQUFJZixhQUN6QixDQUNGLENBR0E0QixLQUFRQyxHQUNOLElBQU1DLEVBQU8sSUFBSWxCLGlCQUFvQkssS0FBS0ksUUFBd0NKLEtBQUtGLFdBQWtCLEVBR3pHLE9BRkFlLEVBQUtELFNBQVdBLEVBQ2hCQyxF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cm5hbC9vYnNlcnZhYmxlL2RvbS9XZWJTb2NrZXRTdWJqZWN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgQW5vbnltb3VzU3ViamVjdCB9IGZyb20gJy4uLy4uL1N1YmplY3QnO1xuaW1wb3J0IHsgU3Vic2NyaWJlciB9IGZyb20gJy4uLy4uL1N1YnNjcmliZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJy4uLy4uL09ic2VydmFibGUnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAnLi4vLi4vU3Vic2NyaXB0aW9uJztcbmltcG9ydCB7IE9wZXJhdG9yIH0gZnJvbSAnLi4vLi4vT3BlcmF0b3InO1xuaW1wb3J0IHsgUmVwbGF5U3ViamVjdCB9IGZyb20gJy4uLy4uL1JlcGxheVN1YmplY3QnO1xuaW1wb3J0IHsgT2JzZXJ2ZXIsIE5leHRPYnNlcnZlciB9IGZyb20gJy4uLy4uL3R5cGVzJztcblxuLyoqXG4gKiBXZWJTb2NrZXRTdWJqZWN0Q29uZmlnIGlzIGEgcGxhaW4gT2JqZWN0IHRoYXQgYWxsb3dzIHVzIHRvIG1ha2Ugb3VyXG4gKiB3ZWJTb2NrZXQgY29uZmlndXJhYmxlLlxuICpcbiAqIDxzcGFuIGNsYXNzPVwiaW5mb3JtYWxcIj5Qcm92aWRlcyBmbGV4aWJpbGl0eSB0byB7QGxpbmsgd2ViU29ja2V0fTwvc3Bhbj5cbiAqXG4gKiBJdCBkZWZpbmVzIGEgc2V0IG9mIHByb3BlcnRpZXMgdG8gcHJvdmlkZSBjdXN0b20gYmVoYXZpb3IgaW4gc3BlY2lmaWNcbiAqIG1vbWVudHMgb2YgdGhlIHNvY2tldCdzIGxpZmVjeWNsZS4gV2hlbiB0aGUgY29ubmVjdGlvbiBvcGVucyB3ZSBjYW5cbiAqIHVzZSBgb3Blbk9ic2VydmVyYCwgd2hlbiB0aGUgY29ubmVjdGlvbiBpcyBjbG9zZWQgYGNsb3NlT2JzZXJ2ZXJgLCBpZiB3ZVxuICogYXJlIGludGVyZXN0ZWQgaW4gbGlzdGVuaW5nIGZvciBkYXRhIGNvbWluZyBmcm9tIHNlcnZlcjogYGRlc2VyaWFsaXplcmAsXG4gKiB3aGljaCBhbGxvd3MgdXMgdG8gY3VzdG9taXplIHRoZSBkZXNlcmlhbGl6YXRpb24gc3RyYXRlZ3kgb2YgZGF0YSBiZWZvcmUgcGFzc2luZyBpdFxuICogdG8gdGhlIHNvY2tldCBjbGllbnQuIEJ5IGRlZmF1bHQsIGBkZXNlcmlhbGl6ZXJgIGlzIGdvaW5nIHRvIGFwcGx5IGBKU09OLnBhcnNlYCB0byBlYWNoIG1lc3NhZ2UgY29taW5nXG4gKiBmcm9tIHRoZSBTZXJ2ZXIuXG4gKlxuICogIyMgRXhhbXBsZXNcbiAqXG4gKiAqKmRlc2VyaWFsaXplcioqLCB0aGUgZGVmYXVsdCBmb3IgdGhpcyBwcm9wZXJ0eSBpcyBgSlNPTi5wYXJzZWAgYnV0IHNpbmNlIHRoZXJlIGFyZSBqdXN0IHR3byBvcHRpb25zXG4gKiBmb3IgaW5jb21pbmcgZGF0YSwgZWl0aGVyIGJlIHRleHQgb3IgYmluYXJ5IGRhdGEuIFdlIGNhbiBhcHBseSBhIGN1c3RvbSBkZXNlcmlhbGl6YXRpb24gc3RyYXRlZ3lcbiAqIG9yIGp1c3Qgc2ltcGx5IHNraXAgdGhlIGRlZmF1bHQgYmVoYXZpb3VyLlxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyB3ZWJTb2NrZXQgfSBmcm9tICdyeGpzL3dlYlNvY2tldCc7XG4gKlxuICogY29uc3Qgd3NTdWJqZWN0ID0gd2ViU29ja2V0KHtcbiAqICAgdXJsOiAnd3M6Ly9sb2NhbGhvc3Q6ODA4MScsXG4gKiAgIC8vQXBwbHkgYW55IHRyYW5zZm9ybWF0aW9uIG9mIHlvdXIgY2hvaWNlLlxuICogICBkZXNlcmlhbGl6ZXI6ICh7IGRhdGEgfSkgPT4gZGF0YVxuICogfSk7XG4gKlxuICogd3NTdWJqZWN0LnN1YnNjcmliZShjb25zb2xlLmxvZyk7XG4gKlxuICogLy8gTGV0J3Mgc3VwcG9zZSB3ZSBoYXZlIHRoaXMgb24gdGhlIFNlcnZlcjogd3Muc2VuZCgnVGhpcyBpcyBhIG1zZyBmcm9tIHRoZSBzZXJ2ZXInKVxuICogLy9vdXRwdXRcbiAqIC8vXG4gKiAvLyBUaGlzIGlzIGEgbXNnIGZyb20gdGhlIHNlcnZlclxuICogYGBgXG4gKlxuICogKipzZXJpYWxpemVyKiogYWxsb3dzIHVzIHRvIGFwcGx5IGN1c3RvbSBzZXJpYWxpemF0aW9uIHN0cmF0ZWd5IGJ1dCBmb3IgdGhlIG91dGdvaW5nIG1lc3NhZ2VzLlxuICpcbiAqIGBgYHRzXG4gKiBpbXBvcnQgeyB3ZWJTb2NrZXQgfSBmcm9tICdyeGpzL3dlYlNvY2tldCc7XG4gKlxuICogY29uc3Qgd3NTdWJqZWN0ID0gd2ViU29ja2V0KHtcbiAqICAgdXJsOiAnd3M6Ly9sb2NhbGhvc3Q6ODA4MScsXG4gKiAgIC8vIEFwcGx5IGFueSB0cmFuc2Zvcm1hdGlvbiBvZiB5b3VyIGNob2ljZS5cbiAqICAgc2VyaWFsaXplcjogbXNnID0+IEpTT04uc3RyaW5naWZ5KHsgY2hhbm5lbDogJ3dlYkRldmVsb3BtZW50JywgbXNnOiBtc2cgfSlcbiAqIH0pO1xuICpcbiAqIHdzU3ViamVjdC5zdWJzY3JpYmUoKCkgPT4gc3ViamVjdC5uZXh0KCdtc2cgdG8gdGhlIHNlcnZlcicpKTtcbiAqXG4gKiAvLyBMZXQncyBzdXBwb3NlIHdlIGhhdmUgdGhpcyBvbiB0aGUgU2VydmVyOlxuICogLy8gICB3cy5vbignbWVzc2FnZScsIG1zZyA9PiBjb25zb2xlLmxvZyk7XG4gKiAvLyAgIHdzLnNlbmQoJ1RoaXMgaXMgYSBtc2cgZnJvbSB0aGUgc2VydmVyJyk7XG4gKiAvLyBvdXRwdXQgYXQgc2VydmVyIHNpZGU6XG4gKiAvL1xuICogLy8ge1wiY2hhbm5lbFwiOlwid2ViRGV2ZWxvcG1lbnRcIixcIm1zZ1wiOlwibXNnIHRvIHRoZSBzZXJ2ZXJcIn1cbiAqIGBgYFxuICpcbiAqICoqY2xvc2VPYnNlcnZlcioqIGFsbG93cyB1cyB0byBzZXQgYSBjdXN0b20gZXJyb3Igd2hlbiBhbiBlcnJvciByYWlzZXMgdXAuXG4gKlxuICogYGBgdHNcbiAqIGltcG9ydCB7IHdlYlNvY2tldCB9IGZyb20gJ3J4anMvd2ViU29ja2V0JztcbiAqXG4gKiBjb25zdCB3c1N1YmplY3QgPSB3ZWJTb2NrZXQoe1xuICogICB1cmw6ICd3czovL2xvY2FsaG9zdDo4MDgxJyxcbiAqICAgY2xvc2VPYnNlcnZlcjoge1xuICogICAgIG5leHQoKSB7XG4gKiAgICAgICBjb25zdCBjdXN0b21FcnJvciA9IHsgY29kZTogNjY2NiwgcmVhc29uOiAnQ3VzdG9tIGV2aWwgcmVhc29uJyB9XG4gKiAgICAgICBjb25zb2xlLmxvZyhgY29kZTogJHsgY3VzdG9tRXJyb3IuY29kZSB9LCByZWFzb246ICR7IGN1c3RvbUVycm9yLnJlYXNvbiB9YCk7XG4gKiAgICAgfVxuICogICB9XG4gKiB9KTtcbiAqXG4gKiAvLyBvdXRwdXRcbiAqIC8vIGNvZGU6IDY2NjYsIHJlYXNvbjogQ3VzdG9tIGV2aWwgcmVhc29uXG4gKiBgYGBcbiAqXG4gKiAqKm9wZW5PYnNlcnZlcioqLCBMZXQncyBzYXkgd2UgbmVlZCB0byBtYWtlIHNvbWUga2luZCBvZiBpbml0IHRhc2sgYmVmb3JlIHNlbmRpbmcvcmVjZWl2aW5nIG1zZ3MgdG8gdGhlXG4gKiB3ZWJTb2NrZXQgb3Igc2VuZGluZyBub3RpZmljYXRpb24gdGhhdCB0aGUgY29ubmVjdGlvbiB3YXMgc3VjY2Vzc2Z1bCwgdGhpcyBpcyB3aGVuXG4gKiBvcGVuT2JzZXJ2ZXIgaXMgdXNlZnVsIGZvci5cbiAqXG4gKiBgYGB0c1xuICogaW1wb3J0IHsgd2ViU29ja2V0IH0gZnJvbSAncnhqcy93ZWJTb2NrZXQnO1xuICpcbiAqIGNvbnN0IHdzU3ViamVjdCA9IHdlYlNvY2tldCh7XG4gKiAgIHVybDogJ3dzOi8vbG9jYWxob3N0OjgwODEnLFxuICogICBvcGVuT2JzZXJ2ZXI6IHtcbiAqICAgICBuZXh0OiAoKSA9PiB7XG4gKiAgICAgICBjb25zb2xlLmxvZygnQ29ubmVjdGlvbiBvaycpO1xuICogICAgIH1cbiAqICAgfVxuICogfSk7XG4gKlxuICogLy8gb3V0cHV0XG4gKiAvLyBDb25uZWN0aW9uIG9rXG4gKiBgYGBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBXZWJTb2NrZXRTdWJqZWN0Q29uZmlnPFQ+IHtcbiAgLyoqIFRoZSB1cmwgb2YgdGhlIHNvY2tldCBzZXJ2ZXIgdG8gY29ubmVjdCB0byAqL1xuICB1cmw6IHN0cmluZztcbiAgLyoqIFRoZSBwcm90b2NvbCB0byB1c2UgdG8gY29ubmVjdCAqL1xuICBwcm90b2NvbD86IHN0cmluZyB8IEFycmF5PHN0cmluZz47XG4gIC8qKiBAZGVwcmVjYXRlZCBXaWxsIGJlIHJlbW92ZWQgaW4gdjguIFVzZSB7QGxpbmsgZGVzZXJpYWxpemVyfSBpbnN0ZWFkLiAqL1xuICByZXN1bHRTZWxlY3Rvcj86IChlOiBNZXNzYWdlRXZlbnQpID0+IFQ7XG4gIC8qKlxuICAgKiBBIHNlcmlhbGl6ZXIgdXNlZCB0byBjcmVhdGUgbWVzc2FnZXMgZnJvbSBwYXNzZWQgdmFsdWVzIGJlZm9yZSB0aGVcbiAgICogbWVzc2FnZXMgYXJlIHNlbnQgdG8gdGhlIHNlcnZlci4gRGVmYXVsdHMgdG8gSlNPTi5zdHJpbmdpZnkuXG4gICAqL1xuICBzZXJpYWxpemVyPzogKHZhbHVlOiBUKSA9PiBXZWJTb2NrZXRNZXNzYWdlO1xuICAvKipcbiAgICogQSBkZXNlcmlhbGl6ZXIgdXNlZCBmb3IgbWVzc2FnZXMgYXJyaXZpbmcgb24gdGhlIHNvY2tldCBmcm9tIHRoZVxuICAgKiBzZXJ2ZXIuIERlZmF1bHRzIHRvIEpTT04ucGFyc2UuXG4gICAqL1xuICBkZXNlcmlhbGl6ZXI/OiAoZTogTWVzc2FnZUV2ZW50KSA9PiBUO1xuICAvKipcbiAgICogQW4gT2JzZXJ2ZXIgdGhhdCB3YXRjaGVzIHdoZW4gb3BlbiBldmVudHMgb2NjdXIgb24gdGhlIHVuZGVybHlpbmcgd2ViIHNvY2tldC5cbiAgICovXG4gIG9wZW5PYnNlcnZlcj86IE5leHRPYnNlcnZlcjxFdmVudD47XG4gIC8qKlxuICAgKiBBbiBPYnNlcnZlciB0aGF0IHdhdGNoZXMgd2hlbiBjbG9zZSBldmVudHMgb2NjdXIgb24gdGhlIHVuZGVybHlpbmcgd2ViIHNvY2tldFxuICAgKi9cbiAgY2xvc2VPYnNlcnZlcj86IE5leHRPYnNlcnZlcjxDbG9zZUV2ZW50PjtcbiAgLyoqXG4gICAqIEFuIE9ic2VydmVyIHRoYXQgd2F0Y2hlcyB3aGVuIGEgY2xvc2UgaXMgYWJvdXQgdG8gb2NjdXIgZHVlIHRvXG4gICAqIHVuc3Vic2NyaXB0aW9uLlxuICAgKi9cbiAgY2xvc2luZ09ic2VydmVyPzogTmV4dE9ic2VydmVyPHZvaWQ+O1xuICAvKipcbiAgICogQSBXZWJTb2NrZXQgY29uc3RydWN0b3IgdG8gdXNlLiBUaGlzIGlzIHVzZWZ1bCBmb3Igc2l0dWF0aW9ucyBsaWtlIHVzaW5nIGFcbiAgICogV2ViU29ja2V0IGltcGwgaW4gTm9kZSAoV2ViU29ja2V0IGlzIGEgRE9NIEFQSSksIG9yIGZvciBtb2NraW5nIGEgV2ViU29ja2V0XG4gICAqIGZvciB0ZXN0aW5nIHB1cnBvc2VzXG4gICAqL1xuICBXZWJTb2NrZXRDdG9yPzogeyBuZXcgKHVybDogc3RyaW5nLCBwcm90b2NvbHM/OiBzdHJpbmcgfCBzdHJpbmdbXSk6IFdlYlNvY2tldCB9O1xuICAvKiogU2V0cyB0aGUgYGJpbmFyeVR5cGVgIHByb3BlcnR5IG9mIHRoZSB1bmRlcmx5aW5nIFdlYlNvY2tldC4gKi9cbiAgYmluYXJ5VHlwZT86ICdibG9iJyB8ICdhcnJheWJ1ZmZlcic7XG59XG5cbmNvbnN0IERFRkFVTFRfV0VCU09DS0VUX0NPTkZJRzogV2ViU29ja2V0U3ViamVjdENvbmZpZzxhbnk+ID0ge1xuICB1cmw6ICcnLFxuICBkZXNlcmlhbGl6ZXI6IChlOiBNZXNzYWdlRXZlbnQpID0+IEpTT04ucGFyc2UoZS5kYXRhKSxcbiAgc2VyaWFsaXplcjogKHZhbHVlOiBhbnkpID0+IEpTT04uc3RyaW5naWZ5KHZhbHVlKSxcbn07XG5cbmNvbnN0IFdFQlNPQ0tFVFNVQkpFQ1RfSU5WQUxJRF9FUlJPUl9PQkpFQ1QgPVxuICAnV2ViU29ja2V0U3ViamVjdC5lcnJvciBtdXN0IGJlIGNhbGxlZCB3aXRoIGFuIG9iamVjdCB3aXRoIGFuIGVycm9yIGNvZGUsIGFuZCBhbiBvcHRpb25hbCByZWFzb246IHsgY29kZTogbnVtYmVyLCByZWFzb246IHN0cmluZyB9JztcblxuZXhwb3J0IHR5cGUgV2ViU29ja2V0TWVzc2FnZSA9IHN0cmluZyB8IEFycmF5QnVmZmVyIHwgQmxvYiB8IEFycmF5QnVmZmVyVmlldztcblxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldFN1YmplY3Q8VD4gZXh0ZW5kcyBBbm9ueW1vdXNTdWJqZWN0PFQ+IHtcbiAgLy8gQHRzLWlnbm9yZTogUHJvcGVydHkgaGFzIG5vIGluaXRpYWxpemVyIGFuZCBpcyBub3QgZGVmaW5pdGVseSBhc3NpZ25lZFxuICBwcml2YXRlIF9jb25maWc6IFdlYlNvY2tldFN1YmplY3RDb25maWc8VD47XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICAvLyBAdHMtaWdub3JlOiBQcm9wZXJ0eSBoYXMgbm8gaW5pdGlhbGl6ZXIgYW5kIGlzIG5vdCBkZWZpbml0ZWx5IGFzc2lnbmVkXG4gIF9vdXRwdXQ6IFN1YmplY3Q8VD47XG5cbiAgcHJpdmF0ZSBfc29ja2V0OiBXZWJTb2NrZXQgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcih1cmxDb25maWdPclNvdXJjZTogc3RyaW5nIHwgV2ViU29ja2V0U3ViamVjdENvbmZpZzxUPiB8IE9ic2VydmFibGU8VD4sIGRlc3RpbmF0aW9uPzogT2JzZXJ2ZXI8VD4pIHtcbiAgICBzdXBlcigpO1xuICAgIGlmICh1cmxDb25maWdPclNvdXJjZSBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgIHRoaXMuZGVzdGluYXRpb24gPSBkZXN0aW5hdGlvbjtcbiAgICAgIHRoaXMuc291cmNlID0gdXJsQ29uZmlnT3JTb3VyY2UgYXMgT2JzZXJ2YWJsZTxUPjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY29uZmlnID0gKHRoaXMuX2NvbmZpZyA9IHsgLi4uREVGQVVMVF9XRUJTT0NLRVRfQ09ORklHIH0pO1xuICAgICAgdGhpcy5fb3V0cHV0ID0gbmV3IFN1YmplY3Q8VD4oKTtcbiAgICAgIGlmICh0eXBlb2YgdXJsQ29uZmlnT3JTb3VyY2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbmZpZy51cmwgPSB1cmxDb25maWdPclNvdXJjZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHVybENvbmZpZ09yU291cmNlKSB7XG4gICAgICAgICAgaWYgKHVybENvbmZpZ09yU291cmNlLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgIChjb25maWcgYXMgYW55KVtrZXldID0gKHVybENvbmZpZ09yU291cmNlIGFzIGFueSlba2V5XTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKCFjb25maWcuV2ViU29ja2V0Q3RvciAmJiBXZWJTb2NrZXQpIHtcbiAgICAgICAgY29uZmlnLldlYlNvY2tldEN0b3IgPSBXZWJTb2NrZXQ7XG4gICAgICB9IGVsc2UgaWYgKCFjb25maWcuV2ViU29ja2V0Q3Rvcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIFdlYlNvY2tldCBjb25zdHJ1Y3RvciBjYW4gYmUgZm91bmQnKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGVzdGluYXRpb24gPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBAZGVwcmVjYXRlZCBJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWwsIGRvIG5vdCB1c2UgZGlyZWN0bHkuIFdpbGwgYmUgbWFkZSBpbnRlcm5hbCBpbiB2OC4gKi9cbiAgbGlmdDxSPihvcGVyYXRvcjogT3BlcmF0b3I8VCwgUj4pOiBXZWJTb2NrZXRTdWJqZWN0PFI+IHtcbiAgICBjb25zdCBzb2NrID0gbmV3IFdlYlNvY2tldFN1YmplY3Q8Uj4odGhpcy5fY29uZmlnIGFzIFdlYlNvY2tldFN1YmplY3RDb25maWc8YW55PiwgdGhpcy5kZXN0aW5hdGlvbiBhcyBhbnkpO1xuICAgIHNvY2sub3BlcmF0b3IgPSBvcGVyYXRvcjtcbiAgICBzb2NrLnNvdXJjZSA9IHRoaXM7XG4gICAgcmV0dXJuIHNvY2s7XG4gIH1cblxuICBwcml2YXRlIF9yZXNldFN0YXRlKCkge1xuICAgIHRoaXMuX3NvY2tldCA9IG51bGw7XG4gICAgaWYgKCF0aGlzLnNvdXJjZSkge1xuICAgICAgdGhpcy5kZXN0aW5hdGlvbiA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XG4gICAgfVxuICAgIHRoaXMuX291dHB1dCA9IG5ldyBTdWJqZWN0PFQ+KCk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiB7QGxpbmsgT2JzZXJ2YWJsZX0sIHRoYXQgd2hlbiBzdWJzY3JpYmVkIHRvLCBzZW5kcyBhIG1lc3NhZ2UsXG4gICAqIGRlZmluZWQgYnkgdGhlIGBzdWJNc2dgIGZ1bmN0aW9uLCB0byB0aGUgc2VydmVyIG92ZXIgdGhlIHNvY2tldCB0byBiZWdpbiBhXG4gICAqIHN1YnNjcmlwdGlvbiB0byBkYXRhIG92ZXIgdGhhdCBzb2NrZXQuIE9uY2UgZGF0YSBhcnJpdmVzLCB0aGVcbiAgICogYG1lc3NhZ2VGaWx0ZXJgIGFyZ3VtZW50IHdpbGwgYmUgdXNlZCB0byBzZWxlY3QgdGhlIGFwcHJvcHJpYXRlIGRhdGEgZm9yXG4gICAqIHRoZSByZXN1bHRpbmcgT2JzZXJ2YWJsZS4gV2hlbiBmaW5hbGl6YXRpb24gb2NjdXJzLCBlaXRoZXIgZHVlIHRvXG4gICAqIHVuc3Vic2NyaXB0aW9uLCBjb21wbGV0aW9uLCBvciBlcnJvciwgYSBtZXNzYWdlIGRlZmluZWQgYnkgdGhlIGB1bnN1Yk1zZ2BcbiAgICogYXJndW1lbnQgd2lsbCBiZSBzZW50IHRvIHRoZSBzZXJ2ZXIgb3ZlciB0aGUgV2ViU29ja2V0U3ViamVjdC5cbiAgICpcbiAgICogQHBhcmFtIHN1Yk1zZyBBIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIHRoZSBzdWJzY3JpcHRpb24gbWVzc2FnZSB0byBiZSBzZW50IHRvXG4gICAqIHRoZSBzZXJ2ZXIuIFRoaXMgd2lsbCBzdGlsbCBiZSBwcm9jZXNzZWQgYnkgdGhlIHNlcmlhbGl6ZXIgaW4gdGhlXG4gICAqIFdlYlNvY2tldFN1YmplY3QncyBjb25maWcuIChXaGljaCBkZWZhdWx0cyB0byBKU09OIHNlcmlhbGl6YXRpb24pXG4gICAqIEBwYXJhbSB1bnN1Yk1zZyBBIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIHRoZSB1bnN1YnNjcmlwdGlvbiBtZXNzYWdlIHRvIGJlXG4gICAqIHNlbnQgdG8gdGhlIHNlcnZlciBhdCBmaW5hbGl6YXRpb24uIFRoaXMgd2lsbCBzdGlsbCBiZSBwcm9jZXNzZWQgYnkgdGhlXG4gICAqIHNlcmlhbGl6ZXIgaW4gdGhlIFdlYlNvY2tldFN1YmplY3QncyBjb25maWcuXG4gICAqIEBwYXJhbSBtZXNzYWdlRmlsdGVyIEEgcHJlZGljYXRlIGZvciBzZWxlY3RpbmcgdGhlIGFwcHJvcHJpYXRlIG1lc3NhZ2VzXG4gICAqIGZyb20gdGhlIHNlcnZlciBmb3IgdGhlIG91dHB1dCBzdHJlYW0uXG4gICAqL1xuICBtdWx0aXBsZXgoc3ViTXNnOiAoKSA9PiBhbnksIHVuc3ViTXNnOiAoKSA9PiBhbnksIG1lc3NhZ2VGaWx0ZXI6ICh2YWx1ZTogVCkgPT4gYm9vbGVhbikge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IE9ic2VydmVyPFQ+KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBzZWxmLm5leHQoc3ViTXNnKCkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHNlbGYuc3Vic2NyaWJlKHtcbiAgICAgICAgbmV4dDogKHgpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2VGaWx0ZXIoeCkpIHtcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKGVycikgPT4gb2JzZXJ2ZXIuZXJyb3IoZXJyKSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IG9ic2VydmVyLmNvbXBsZXRlKCksXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBzZWxmLm5leHQodW5zdWJNc2coKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfY29ubmVjdFNvY2tldCgpIHtcbiAgICBjb25zdCB7IFdlYlNvY2tldEN0b3IsIHByb3RvY29sLCB1cmwsIGJpbmFyeVR5cGUgfSA9IHRoaXMuX2NvbmZpZztcbiAgICBjb25zdCBvYnNlcnZlciA9IHRoaXMuX291dHB1dDtcblxuICAgIGxldCBzb2NrZXQ6IFdlYlNvY2tldCB8IG51bGwgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBzb2NrZXQgPSBwcm90b2NvbCA/IG5ldyBXZWJTb2NrZXRDdG9yISh1cmwsIHByb3RvY29sKSA6IG5ldyBXZWJTb2NrZXRDdG9yISh1cmwpO1xuICAgICAgdGhpcy5fc29ja2V0ID0gc29ja2V0O1xuICAgICAgaWYgKGJpbmFyeVR5cGUpIHtcbiAgICAgICAgdGhpcy5fc29ja2V0LmJpbmFyeVR5cGUgPSBiaW5hcnlUeXBlO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIG9ic2VydmVyLmVycm9yKGUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKCkgPT4ge1xuICAgICAgdGhpcy5fc29ja2V0ID0gbnVsbDtcbiAgICAgIGlmIChzb2NrZXQgJiYgc29ja2V0LnJlYWR5U3RhdGUgPT09IDEpIHtcbiAgICAgICAgc29ja2V0LmNsb3NlKCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBzb2NrZXQub25vcGVuID0gKGV2dDogRXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHsgX3NvY2tldCB9ID0gdGhpcztcbiAgICAgIGlmICghX3NvY2tldCkge1xuICAgICAgICBzb2NrZXQhLmNsb3NlKCk7XG4gICAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgeyBvcGVuT2JzZXJ2ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgIGlmIChvcGVuT2JzZXJ2ZXIpIHtcbiAgICAgICAgb3Blbk9ic2VydmVyLm5leHQoZXZ0KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcXVldWUgPSB0aGlzLmRlc3RpbmF0aW9uO1xuXG4gICAgICB0aGlzLmRlc3RpbmF0aW9uID0gU3Vic2NyaWJlci5jcmVhdGU8VD4oXG4gICAgICAgICh4KSA9PiB7XG4gICAgICAgICAgaWYgKHNvY2tldCEucmVhZHlTdGF0ZSA9PT0gMSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3QgeyBzZXJpYWxpemVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICAgICAgICAgIHNvY2tldCEuc2VuZChzZXJpYWxpemVyISh4ISkpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICB0aGlzLmRlc3RpbmF0aW9uIS5lcnJvcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zdCB7IGNsb3NpbmdPYnNlcnZlciB9ID0gdGhpcy5fY29uZmlnO1xuICAgICAgICAgIGlmIChjbG9zaW5nT2JzZXJ2ZXIpIHtcbiAgICAgICAgICAgIGNsb3NpbmdPYnNlcnZlci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUpIHtcbiAgICAgICAgICAgIHNvY2tldCEuY2xvc2UoZXJyLmNvZGUsIGVyci5yZWFzb24pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihuZXcgVHlwZUVycm9yKFdFQlNPQ0tFVFNVQkpFQ1RfSU5WQUxJRF9FUlJPUl9PQkpFQ1QpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgICAgICB9LFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBjbG9zaW5nT2JzZXJ2ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgICAgICBpZiAoY2xvc2luZ09ic2VydmVyKSB7XG4gICAgICAgICAgICBjbG9zaW5nT2JzZXJ2ZXIubmV4dCh1bmRlZmluZWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBzb2NrZXQhLmNsb3NlKCk7XG4gICAgICAgICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgICAgICB9XG4gICAgICApIGFzIFN1YnNjcmliZXI8YW55PjtcblxuICAgICAgaWYgKHF1ZXVlICYmIHF1ZXVlIGluc3RhbmNlb2YgUmVwbGF5U3ViamVjdCkge1xuICAgICAgICBzdWJzY3JpcHRpb24uYWRkKChxdWV1ZSBhcyBSZXBsYXlTdWJqZWN0PFQ+KS5zdWJzY3JpYmUodGhpcy5kZXN0aW5hdGlvbikpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBzb2NrZXQub25lcnJvciA9IChlOiBFdmVudCkgPT4ge1xuICAgICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgICAgb2JzZXJ2ZXIuZXJyb3IoZSk7XG4gICAgfTtcblxuICAgIHNvY2tldC5vbmNsb3NlID0gKGU6IENsb3NlRXZlbnQpID0+IHtcbiAgICAgIGlmIChzb2NrZXQgPT09IHRoaXMuX3NvY2tldCkge1xuICAgICAgICB0aGlzLl9yZXNldFN0YXRlKCk7XG4gICAgICB9XG4gICAgICBjb25zdCB7IGNsb3NlT2JzZXJ2ZXIgfSA9IHRoaXMuX2NvbmZpZztcbiAgICAgIGlmIChjbG9zZU9ic2VydmVyKSB7XG4gICAgICAgIGNsb3NlT2JzZXJ2ZXIubmV4dChlKTtcbiAgICAgIH1cbiAgICAgIGlmIChlLndhc0NsZWFuKSB7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYnNlcnZlci5lcnJvcihlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgc29ja2V0Lm9ubWVzc2FnZSA9IChlOiBNZXNzYWdlRXZlbnQpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgZGVzZXJpYWxpemVyIH0gPSB0aGlzLl9jb25maWc7XG4gICAgICAgIG9ic2VydmVyLm5leHQoZGVzZXJpYWxpemVyIShlKSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICBwcm90ZWN0ZWQgX3N1YnNjcmliZShzdWJzY3JpYmVyOiBTdWJzY3JpYmVyPFQ+KTogU3Vic2NyaXB0aW9uIHtcbiAgICBjb25zdCB7IHNvdXJjZSB9ID0gdGhpcztcbiAgICBpZiAoc291cmNlKSB7XG4gICAgICByZXR1cm4gc291cmNlLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLl9zb2NrZXQpIHtcbiAgICAgIHRoaXMuX2Nvbm5lY3RTb2NrZXQoKTtcbiAgICB9XG4gICAgdGhpcy5fb3V0cHV0LnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgICBzdWJzY3JpYmVyLmFkZCgoKSA9PiB7XG4gICAgICBjb25zdCB7IF9zb2NrZXQgfSA9IHRoaXM7XG4gICAgICBpZiAodGhpcy5fb3V0cHV0Lm9ic2VydmVycy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgaWYgKF9zb2NrZXQgJiYgKF9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMSB8fCBfc29ja2V0LnJlYWR5U3RhdGUgPT09IDApKSB7XG4gICAgICAgICAgX3NvY2tldC5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3Jlc2V0U3RhdGUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gc3Vic2NyaWJlcjtcbiAgfVxuXG4gIHVuc3Vic2NyaWJlKCkge1xuICAgIGNvbnN0IHsgX3NvY2tldCB9ID0gdGhpcztcbiAgICBpZiAoX3NvY2tldCAmJiAoX3NvY2tldC5yZWFkeVN0YXRlID09PSAxIHx8IF9zb2NrZXQucmVhZHlTdGF0ZSA9PT0gMCkpIHtcbiAgICAgIF9zb2NrZXQuY2xvc2UoKTtcbiAgICB9XG4gICAgdGhpcy5fcmVzZXRTdGF0ZSgpO1xuICAgIHN1cGVyLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==
